item 7.   management's discussion and analysis of financial condition and results of operations the following discussion and analysis should be read in conjunction with the consolidated financial statements and the related notes included elsewhere in this annual report on form 10-k. for discussion related to changes in financial condition and the results of operations for fiscal year 2018-related items, refer to part ii, item 7. management's discussion and analysis of financial condition and results of operations in our annual report on form 10-k for fiscal year 2019, which was filed with the securities and exchange commission on february 13, 2020.
overview and 2020 highlights our mission is to accelerate the world's transition to sustainable energy. we design, develop, manufacture, lease and sell high-performance fully electric vehicles, solar energy generation systems and energy storage products. we also offer maintenance, installation, operation, financial and other services related to our products.
in 2020, we produced 509,737 vehicles and delivered 499,647 vehicles. we are currently focused on increasing vehicle production and capacity, developing and ramping our battery cell technology, increasing the affordability of our vehicles, expanding our global infrastructure and introducing our next vehicles.
in 2020, we deployed 3.02 gwh of energy storage products and 205 megawatts of solar energy systems. we are currently focused on ramping production of energy storage products, improving our solar roof installation capability and efficiency and increasing market share of retrofit solar energy systems.
in 2020, we recognized total revenues of $31.54 billion, representing an increase of $6.96 billion compared to the prior year. we continue to ramp production, build new manufacturing capacity and expand our operations to enable increased deliveries and deployments of our products and further revenue growth.
in 2020, our net income attributable to common stockholders was $721 million, representing a favorable change of $1.58 billion compared to the prior year. in 2020, our operating margin was 6.3%, representing a favorable change of 6.6% compared to the prior year. we continue to focus on operational efficiencies, while we have seen an acceleration of non-cash stock-based compensation expense due to a rapid increase in our market capitalization and updates to our business outlook.
we ended 2020 with $19.38 billion in cash and cash equivalents, representing an increase of $13.12 billion from the end of 2019. our cash flows from operating activities during 2020 was $5.94 billion, compared to $2.41 billion during 2019, and capital expenditures amounted to $3.16 billion during 2020, compared to $1.33 billion during 2019. sustained growth has allowed our business to generally fund itself, but we will continue a number of capital-intensive projects in upcoming periods.
management opportunities, challenges and risks and 2021 outlook impact of covid-19 pandemic there continues to be worldwide impact from the covid-19 pandemic. while we have been relatively successful in navigating such impact to date, we have previously been affected by temporary manufacturing closures, employment and compensation adjustments, and impediments to administrative activities supporting our product deliveries and deployments. there are also ongoing related risks to our business depending on the progression of the pandemic, and recent trends in certain regions have indicated potential returns to limited or closed government functions, business activities and person-to-person interactions. global trade conditions and consumer trends may further adversely impact us and our industries. for example, pandemic-related issues have exacerbated port congestion and intermittent supplier shutdowns and delays, resulting in additional expenses to expedite delivery of critical parts. similarly, increased demand for personal electronics has created a shortfall of microchip supply, and it is yet unknown how we may be impacted. please see the "results of operations" section of this item below and certain risk factors described in part i, item 1a, risk factors in this annual report on form 10-k, particularly the first risk factor included there, for more detailed descriptions of the impact and risks to our business.
we cannot predict the duration or direction of current global trends from this pandemic, the sustained impact of which is largely unknown, is rapidly evolving and has varied across geographic regions. ultimately, we continue to monitor macroeconomic conditions to remain flexible and to optimize and evolve our business as appropriate, and we will have to accurately project demand and infrastructure requirements globally and deploy our production, workforce and other resources accordingly.
automotive-production the following is a summary of the status of production of each of our announced vehicle models in production and under development, as of the date of this annual report on form 10-k:
fremont factory        model s and model x   active model 3 and model y   active gigafactory shanghai   model 3 and model y   active gigafactory berlin     model y               constructing manufacturing facilities gigafactory texas      model y               constructing manufacturing facilities cybertruck            in development tbd                    tesla semi            in development tesla roadster        in development we recently announced updated versions of model s and model x featuring a redesigned powertrain and other improvements. in 2021, we are focused on ramping these models on new manufacturing equipment, as well as production rates of model 3 and model y, to at least the capacity that we have installed. the next phase of production growth will depend on the construction of gigafactory berlin and gigafactory texas, each of which is progressing as planned for deliveries beginning in 2021. our goal is to continuously decrease production costs and increase the affordability of our vehicles. we are continuing to develop and manufacture our own battery cells, with which we are targeting high-volume output, lower capital and production costs and longer range. as cell supply is critical to our business, coupling this strategy with cells from our suppliers will help us stay ahead of any potential constraints.
however, these plans are subject to uncertainties inherent in establishing and ramping manufacturing operations, which may be exacerbated by the number of concurrent international projects and any future impact from events outside of our control such as the covid-19 pandemic and any industry-wide component constraints. moreover, we must meet ambitious technological targets with our plans for battery cells as well as for iterative manufacturing and design improvements for our vehicles with each new factory.
automotive-demand and sales our cost reduction efforts and additional localized procurement and manufacturing are key to our vehicles' affordability, and for example have allowed us to competitively price our vehicles in china. in addition to opening new factories in 2021, we will also continue to generate demand and brand awareness by improving our vehicles' functionality, including autopilot, fsd and software features, and introducing anticipated future vehicles. moreover, we expect to benefit from ongoing electrification of the automotive sector and increasing environmental awareness.
however, we operate in a cyclical industry that is sensitive to trade, environmental and political uncertainty, all of which may also be compounded by any future global impact from the covid-19 pandemic. on the other hand, there have been recent signs of recovery from competitors that experienced downturns in 2020, meaning that we will have to continue to execute well to maintain the momentum that we have gained relative to an ever-growing competitive landscape.
automotive-deliveries and customer infrastructure as our deliveries increase, we must work constantly to prevent our vehicle delivery capability from becoming a bottleneck on our total deliveries. situating our factories closer to local markets should mitigate the strain on our deliveries. in any case, as we expand, we will have to continue to increase and staff our delivery, servicing and charging infrastructure, maintain our vehicle reliability and optimize our supercharger locations to ensure cost-effectiveness and customer satisfaction. in particular, we remain focused on increasing the capability and efficiency of our servicing operations.
energy generation and storage demand, production and deployment the long-term success of this business is dependent upon increasing margins through greater volumes. we continue to increase the production of our energy storage products to meet high levels of demand. for powerwall, better availability and growing grid stability concerns drive higher interest, and cross-selling with our residential solar energy products will continue to benefit both product lines. we remain committed to increasing our retrofit solar energy business by offering a low-cost and simplified online ordering experience. in addition, we are working to improve our installation capabilities for solar roof by on-boarding and training a large number of installers and reducing the installation time dramatically. as these product lines grow, we will have to maintain adequate battery cell supply for our energy storage products and hire additional personnel, particularly skilled electricians to support the ramp of solar roof.
cash flow and capital expenditure trends our capital expenditures are typically difficult to project beyond the short term given the number and breadth of our core projects at any given time, and uncertainties in future global market conditions resulting from the covid-19 pandemic currently makes projections more challenging. we are simultaneously ramping new products in the new model s and model x, model y and solar roof, constructing or ramping manufacturing facilities on three continents and piloting the development and manufacture of new battery cell technologies, and the pace of our capital spend may vary depending on overall priority among projects, the pace at which we meet milestones, production adjustments to and among our various products, increased capital efficiencies and the addition of new projects. owing and subject to the foregoing as well as the pipeline of announced projects under development and all other continuing infrastructure growth, we currently expect our capital expenditures to be $4.50 to $6.00 billion in 2021 and each of the next two fiscal years.
our business has recently been consistently generating cash flow from operations in excess of our level of capital spend, and with better working capital management resulting in shorter days sales outstanding than days payable outstanding, our sales growth is also facilitating positive cash generation. on the other hand, we are likely to see heightened levels of capital expenditures during certain periods depending on the specific pace of our capital-intensive projects. moreover, as our stock price has significantly increased recently, we have seen higher levels of early conversions of "in-the-money" convertible senior notes, which obligates us to deliver cash and or shares pursuant to the terms of those notes. overall, we expect our ability to be self-funding to continue as long as macroeconomic factors support current trends in our sales. we also opportunistically strengthened our liquidity further through an at-the-market offering of common stock in december 2020, with net proceeds to us of approximately $4.99 billion.
operating expense trends as long as we see expanding sales, and excluding the potential impact of non-cash stock compensation expense attributable to the 2018 ceo performance award and impairment charges on certain assets as explained below, we generally expect operating expenses relative to revenues to decrease as we additionally increase operational efficiency and process automation.
in march 2018, our stockholders approved a performance-based stock option award to our ceo (the "2018 ceo performance award"), consisting of 12 vesting tranches contingent on the achievement of specified market capitalization and operational milestones. we incur non-cash stock-based compensation expense for each tranche only after the related operational milestone initially becomes probable of being met based on a subjective assessment of our future financial performance, and if this happens following the grant date, we record at such time a cumulative catch-up expense that may be significant based on the length of time elapsed from the grant date. moreover, the remaining expense for that tranche is ratably recorded over the period remaining until the later of (i) the expected achievement of the relevant operational milestone (if it has not yet been achieved) and (ii) the expected achievement of the related market capitalization milestone (if it has not yet been achieved). upon vesting of a tranche, all remaining associated expense is recognized immediately. because the expected market capitalization achievements are generally later than the related expected operational milestone achievements, the achievement of the former earlier than expected may increase the magnitude of any catch-up expense and/or accelerate the rate at which the remaining expense is recognized. during 2020, several operational milestones became probable and several tranches vested, including as a result of our market capitalization increasing rapidly, resulting in the recognition or acceleration of related expense earlier than anticipated and within a relatively short period of time. see note 14, equity incentive plans-2018 ceo performance award, to the consolidated financial statements included elsewhere in this annual report on form 10-k for further details regarding the stock-based compensation relating to the 2018 ceo performance award. as our market capitalization is unpredictable and our financial performance improves, it is possible that the earlier-than-planned recognition of such expenses will continue in the near term.
in january 2021, we updated our investment policy to provide us with more flexibility to further diversify and maximize returns on our cash that is not required to maintain adequate operating liquidity. as part of the policy, we may invest a portion of such cash in certain specified alternative reserve assets. thereafter, we invested an aggregate $1.50 billion in bitcoin under this policy. moreover, we expect to begin accepting bitcoin as a form of payment for our products in the near future, subject to applicable laws and initially on a limited basis, which we may or may not liquidate upon receipt. digital assets are considered indefinite-lived intangible assets under applicable accounting rules. accordingly, any decrease in their fair values below our carrying values for such assets at any time subsequent to their acquisition will require us to recognize impairment charges, whereas we may make no upward revisions for any market price increases until a sale. as we currently intend to hold these assets long-term, these charges may negatively impact our profitability in the periods in which such impairments occur even if the overall market values of these assets increase.
critical accounting policies and estimates the consolidated financial statements are prepared in accordance with accounting principles generally accepted in the u.s. ("gaap"). the preparation of the consolidated financial statements requires us to make estimates and assumptions that affect the reported amounts of assets, liabilities, revenues, costs and expenses and related disclosures. we base our estimates on historical experience, as appropriate, and on various other assumptions that we believe to be reasonable under the circumstances. changes in the accounting estimates are reasonably likely to occur from period to period. accordingly, actual results could differ significantly from the estimates made by our management. we evaluate our estimates and assumptions on an ongoing basis. to the extent that there are material differences between these estimates and actual results, our future financial statement presentation, financial condition, results of operations and cash flows may be affected.
due to the covid-19 pandemic, there has been uncertainty and disruption in the global economy and financial markets. the estimates used for, but not limited to, determining significant economic incentive for resale value guarantee arrangements, sales return reserves, the collectability of accounts receivable, inventory valuation, fair value of long-lived assets, goodwill, fair value of financial instruments, fair value and residual value of operating lease vehicles and solar energy systems subject to leases could be impacted. we have assessed the impact and are not aware of any specific events or circumstances that required an update to our estimates and assumptions or materially affected the carrying value of our assets or liabilities as of the date of issuance of this annual report on form 10-k. these estimates may change as new events occur and additional information is obtained. actual results could differ materially from these estimates under different assumptions or conditions.
revenue recognition automotive segment automotive sales revenue automotive sales without resale value guarantee automotive sales revenue includes revenues related to deliveries of new vehicles and pay-per-use charges, and specific other features and services that meet the definition of a performance obligation under asc 606, including access to our supercharger network, internet connectivity, fsd features and over-the-air software updates. we recognize revenue on automotive sales upon delivery to the customer, which is when the control of a vehicle transfers. payments are typically received at the point control transfers or in accordance with payment terms customary to the business. other features and services such as access to our supercharger network, internet connectivity and over-the-air software updates are provisioned upon control transfer of a vehicle and recognized over time on a straight-line basis as we have a stand-ready obligation to deliver such services to the customer. we recognize revenue related to these other features and services over the performance period, which is generally the expected ownership life of the vehicle or the eight-year life of the vehicle. revenue related to fsd features is recognized when functionality is delivered to the customer. for our obligations related to automotive sales, we estimate standalone selling price by considering costs used to develop and deliver the service, third-party pricing of similar options and other information that may be available.
at the time of revenue recognition, we reduce the transaction price and record a sales return reserve against revenue for estimated variable consideration related to future product returns based on historical experience. in addition, any fees that are paid or payable by us to a customer's lender when we arrange the financing are recognized as an offset against automotive sales revenue.
costs to obtain a contract mainly relate to commissions paid to our sales personnel for the sale of vehicles. commissions are not paid on other obligations such as access to our supercharger network, internet connectivity, fsd features and over-the-air software updates. as our contract costs related to automotive sales are typically fulfilled within one year, the costs to obtain a contract are expensed as incurred. amounts billed to customers related to shipping and handling are classified as automotive sales revenue, and we have elected to recognize the cost for freight and shipping when control over vehicles, parts or accessories have transferred to the customer as an expense in cost of automotive sales revenue. our policy is to exclude taxes collected from a customer from the transaction price of automotive contracts.
automotive sales with resale value guarantee or a buyback option we offer resale value guarantees or similar buy-back terms to certain international customers who purchase vehicles and who finance their vehicles through one of our specified commercial banking partners. we also offer resale value guarantees in connection with automotive sales to certain leasing partners. under these programs, we receive full payment for the vehicle sales price at the time of delivery and our counterparty has the option of selling their vehicle back to us during the guarantee period, which currently is generally at the end of the term of the applicable loan or financing program, for a pre-determined resale value.
with the exception of the vehicle sales to leasing partners with a resale value guarantee and a buyback option program discussed within the automotive leasing section below, we recognize revenue when control transfers upon delivery to customers in accordance with asc 606 as a sale with a right of return as we do not believe the customer has a significant economic incentive to exercise the resale value guarantee provided to them at contract inception. the process to determine whether there is a significant economic incentive includes a comparison of a vehicle's estimated market value at the time the option is exercisable with the guaranteed resale value to determine the customer's economic incentive to exercise. the performance obligations and the pattern of recognizing automotive sales with resale value guarantees are consistent with automotive sales without resale value guarantees with the exception of our estimate for sales return reserve. sales return reserves for automotive sales with resale value guarantees are estimated based on historical experience plus consideration for expected future market values. on a quarterly basis, we assess the estimated market values of vehicles under our buyback options program to determine whether there have been changes to the likelihood of future product returns. as we accumulate more data related to the buyback values of our vehicles or as market conditions change, there may be material changes to their estimated values.
automotive regulatory credits we earn tradable credits in the operation of our automotive business under various regulations related to zevs, greenhouse gas, fuel economy and clean fuel. we sell these credits to other regulated entities who can use the credits to comply with emission standards and other regulatory requirements. payments for automotive regulatory credits are typically received at the point control transfers to the customer, or in accordance with payment terms customary to the business. we recognize revenue on the sale of automotive regulatory credits at the time control of the regulatory credits is transferred to the purchasing party as automotive sales revenue in the consolidated statements of operations.
automotive leasing revenue direct vehicle operating leasing program we have outstanding leases under our direct vehicle operating leasing programs in the u.s., canada and in certain countries in europe. qualifying customers are permitted to lease a vehicle directly from tesla for up to 48 months. at the end of the lease term, customers are required to return the vehicles to us or for model s and model x leases in certain regions, may opt to purchase the vehicles for a pre-determined residual value. we account for these leasing transactions as operating leases. we record leasing revenues to automotive leasing revenue on a straight-line basis over the contractual term, and we record the depreciation of these vehicles to cost of automotive leasing revenue.
our policy is to exclude taxes collected from a customer from the transaction price of automotive contracts.
vehicle sales to leasing partners with a resale value guarantee and a buyback option we offered buyback options in connection with automotive sales with resale value guarantees with certain leasing partner sales in the u.s. and where we expected the customer had a significant economic incentive to exercise the resale value guarantee provided to them at contract inception, we continued to recognize these transactions as operating leases. these transactions entailed a transfer of leases, which we had originated with an end-customer, to our leasing partner. as control of the vehicles had not been transferred in accordance with asc 606, these transactions were accounted for as interest-bearing collateralized borrowings in accordance with asc 840, leases, prior to january 1, 2019. under this program, cash was received for the full price of the vehicle and the collateralized borrowing value was generally recorded within resale value guarantees and the customer upfront down payment was recorded within deferred revenue. we amortize the deferred revenue amount to automotive leasing revenue on a straight-line basis over the option period and accrue interest expense based on our borrowing rate. we capitalized vehicles under this program to operating lease vehicles, net, on the consolidated balance sheets, and we record depreciation from these vehicles to cost of automotive leasing revenue during the period the vehicle is under a lease arrangement. cash received for these vehicles, net of revenue recognized during the period, is classified as collateralized lease (repayments) borrowings within cash flows from financing activities in the consolidated statements of cash flows. with the adoption of asc 842 on january 1, 2019, all new agreements under this program are accounted for as operating leases under asc 842 and there was no material change in the timing and amount of revenue recognized over the term. consequently, any cash flows for new agreements are classified as operating cash activities on the consolidated statements of cash flows.
at the end of the lease term, we settle our liability in cash by either purchasing the vehicle from the leasing partner for the buyback option amount or paying a shortfall to the option amount the leasing partner may realize on the sale of the vehicle. any remaining balances within deferred revenue and resale value guarantee will be settled to automotive leasing revenue. the end customer can extend the lease for a period of up to 6 months. in cases where the leasing partner retains ownership of the vehicle after the end of our option period, we expense the net value of the leased vehicle to cost of automotive leasing revenue.
direct sales-type leasing program we have outstanding direct leases and vehicles financed by us under loan arrangements accounted for as sales-type leases under asc 842 in certain countries in asia and europe, which we introduced in volume during the third quarter of 2020. depending on the specific program, customers may or may not have a right to return the vehicle to us during or at the end of the lease term. if the customer does not have a right to return, the customer will take title to the vehicle at the end of the lease term after making all contractual payments. under the programs for which there is a right to return, the purchase option is reasonably certain to be exercised by the lessee and we therefore expect the customer to take title to the vehicle at the end of the lease term after making all contractual payments. qualifying customers are permitted to lease a vehicle directly under these programs for up to 48 months. our loan arrangements under these programs can have terms for up to 72 months. we recognize all revenue and costs associated with the sales-type lease as automotive leasing revenue and automotive leasing cost of revenue, respectively, upon delivery of the vehicle to the customer. interest income based on the implicit rate in the lease is recorded to automotive leasing revenue over time as customers are invoiced on a monthly basis.
energy generation and storage segment energy generation and storage sales energy generation and storage sales revenue consists of the sale of solar energy systems and energy storage systems to residential, small commercial, and large commercial and utility grade customers, including solar subscription-based arrangements. energy generation and storage sales revenue also includes revenue from agreements for solar energy systems and ppas that commence after january 1, 2019, which is recognized as earned, based on the amount of capacity provided for solar energy systems or electricity delivered for ppas at the contractual billing rates, assuming all other revenue recognition criteria have been met. under the practical expedient available under asc 606-10-55-18, we recognize revenue based on the value of the service which is consistent with the billing amount. sales of solar energy systems to residential and small scale commercial customers consist of the engineering, design and installation of the system. post-installation, residential and small scale commercial customers receive a proprietary monitoring system that captures and displays historical energy generation data. residential and small scale commercial customers pay the full purchase price of the solar energy system upfront. revenue for the design and installation obligation is recognized when control transfers, which is when we install a solar energy system and the system passes inspection by the utility or the authority having jurisdiction. revenue for the monitoring service is recognized ratably as a stand-ready obligation over the warranty period of the solar energy system. sales of energy storage systems to residential and small scale commercial customers consist of the installation of the energy storage system and revenue is recognized when control transfers, which is when the product has been delivered or, if we are performing installation, when installed and commissioned. payment for such storage systems is made upon invoice or in accordance with payment terms customary to the business.
for large commercial and utility grade solar energy system and energy storage system sales which consist of the engineering, design and installation of the system, customers make milestone payments that are consistent with contract-specific phases of a project. revenue from such contracts is recognized over time using the percentage of completion method based on cost incurred as a percentage of total estimated contract costs for energy storage system sales and as a percentage of total estimated labor hours for solar energy system sales. certain large-scale commercial and utility grade solar energy system and energy storage system sales also include operations and maintenance service which are negotiated with the design and installation contracts and are thus considered to be a combined contract with the design and installation service. for certain large commercial and utility grade solar energy systems and energy storage systems where the percentage of completion method does not apply, revenue is recognized when control transfers, which is when the product has been delivered to the customer and commissioned for energy storage systems and when the project has received permission to operate from the utility for solar energy systems. operations and maintenance service revenue is recognized ratably over the respective contract term for solar energy system sales and upon delivery of the service for energy storage system sales. customer payments for such services are usually paid annually or quarterly in advance.
in instances where there are multiple performance obligations in a single contract, we allocate the consideration to the various obligations in the contract based on the relative standalone selling price method. standalone selling prices are estimated based on estimated costs plus margin or by using market data for comparable products. costs incurred on the sale of residential installations before the solar energy systems are completed are included as work in process within inventory in the consolidated balance sheets. any fees that are paid or payable by us to a solar loan lender would be recognized as an offset against revenue. costs to obtain a contract relate mainly to commissions paid to our sales personnel related to the sale of solar energy systems and energy storage systems. as our contract costs related to solar energy system and energy storage system sales are typically fulfilled within one year, the costs to obtain a contract are expensed as incurred.
as part of our solar energy system and energy storage system contracts, we may provide the customer with performance guarantees that warrant that the underlying system will meet or exceed the minimum energy generation or energy performance requirements specified in the contract. in certain instances, we may receive a bonus payment if the system performs above a specified level. conversely, if a solar energy system or energy storage system does not meet the performance guarantee requirements, we may be required to pay liquidated damages. other forms of variable consideration related to our large commercial and utility grade solar energy system and energy storage system contracts include variable customer payments that will be made based on our energy market participation activities. such guarantees and variable customer payments represent a form of variable consideration and are estimated at contract inception at their most likely amount and updated at the end of each reporting period as additional performance data becomes available. such estimates are included in the transaction price only to the extent that it is probable a significant reversal of revenue will not occur.
we record as deferred revenue any non-refundable amounts that are collected from customers related to fees charged for prepayments and remote monitoring service and operations and maintenance service, which is recognized as revenue ratably over the respective customer contract term.
energy generation and storage leasing for revenue arrangements where we are the lessor under operating lease agreements for energy generation and storage products, we record lease revenue from minimum lease payments, including upfront rebates and incentives earned from such systems, on a straight-line basis over the life of the lease term, assuming all other revenue recognition criteria have been met. the difference between the payments received and the revenue recognized is recorded as deferred revenue or deferred asset on the consolidated balance sheet.
for solar energy systems where customers purchase electricity from us under ppas prior to january 1, 2019, we have determined that these agreements should be accounted for as operating leases pursuant to asc 840. revenue is recognized based on the amount of electricity delivered at rates specified under the contracts, assuming all other revenue recognition criteria are met.
we record as deferred revenue any amounts that are collected from customers, including lease prepayments, in excess of revenue recognized and operations and maintenance service fees, which is recognized as revenue ratably over the respective customer contract term. deferred revenue also includes the portion of rebates and incentives received from utility companies and various local and state government agencies, which is recognized as revenue over the lease term.
we capitalize initial direct costs from the execution of agreements for solar energy systems and ppas, which include the referral fees and sales commissions, as an element of solar energy systems, net, and subsequently amortize these costs over the term of the related agreements.
inventory valuation inventories are stated at the lower of cost or net realizable value. cost is computed using standard cost for vehicles and energy storage products, which approximates actual cost on a first-in, first-out basis. in addition, cost for solar energy systems is recorded using actual cost. we record inventory write-downs for excess or obsolete inventories based upon assumptions about current and future demand forecasts. if our inventory on-hand is in excess of our future demand forecast, the excess amounts are written-off.
we also review our inventory to determine whether its carrying value exceeds the net amount realizable upon the ultimate sale of the inventory. this requires us to determine the estimated selling price of our vehicles less the estimated cost to convert the inventory on-hand into a finished product. once inventory is written-down, a new, lower cost basis for that inventory is established and subsequent changes in facts and circumstances do not result in the restoration or increase in that newly established cost basis.
should our estimates of future selling prices or production costs change, additional and potentially material increases to this reserve may be required. a small change in our estimates may result in a material charge to our reported financial results.
warranties we provide a manufacturer's warranty on all new and used vehicles and a warranty on the installation and components of the energy generation and storage systems we sell for periods typically between 10 to 25 years. we accrue a warranty reserve for the products sold by us, which includes our best estimate of the projected costs to repair or replace items under warranties and recalls when identified. these estimates are based on actual claims incurred to date and an estimate of the nature, frequency and costs of future claims. these estimates are inherently uncertain given our relatively short history of sales, and changes to our historical or projected warranty experience may cause material changes to the warranty reserve in the future. the warranty reserve does not include projected warranty costs associated with our vehicles subject to operating lease accounting and our solar energy systems under lease contracts or ppas, as the costs to repair these warranty claims are expensed as incurred. the portion of the warranty reserve expected to be incurred within the next 12 months is included within accrued liabilities and other, while the remaining balance is included within other long-term liabilities on the consolidated balance sheets. warranty expense is recorded as a component of cost of revenues in the consolidated statements of operations.
stock-based compensation we use the fair value method of accounting for our stock options and restricted stock units ("rsus") granted to employees and for our employee stock purchase plan (the "espp") to measure the cost of employee services received in exchange for the stock-based awards. the fair value of stock option awards with only service and/or performance conditions is estimated on the grant or offering date using the black-scholes option-pricing model. the black-scholes option-pricing model requires inputs such as the risk-free interest rate, expected term and expected volatility. these inputs are subjective and generally require significant judgment. the fair value of rsus is measured on the grant date based on the closing fair market value of our common stock. the resulting cost is recognized over the period during which an employee is required to provide service in exchange for the awards, usually the vesting period, which is generally four years for stock options and rsus and six months for the espp. stock-based compensation expense is recognized on a straight-line basis, net of actual forfeitures in the period.
for performance-based awards, stock-based compensation expense is recognized over the expected performance achievement period of individual performance milestones when the achievement of each individual performance milestone becomes probable. for performance-based awards with a vesting schedule based entirely on the attainment of both performance and market conditions, stock-based compensation expense associated with each tranche is recognized over the longer of (i) the expected achievement period for the operational milestone for such tranche and (ii) the expected achievement period for the related market capitalization milestone determined on the grant date, beginning at the point in time when the relevant operational milestone is considered probable of being achieved. if such operational milestone becomes probable any time after the grant date, we will recognize a cumulative catch-up expense from the grant date to that point in time. if the related market capitalization milestone is achieved earlier than its expected achievement period and the achievement of the related operational milestone, then the stock-based compensation expense will be recognized over the expected achievement period for the operational milestone, which may accelerate the rate at which such expense is recognized. if additional operational milestones become probable, stock-based compensation expense will be recorded in the period it becomes probable including cumulative catch-up expense for the service provided since the grant date. the fair value of such awards is estimated on the grant date using monte carlo simulations.
as we accumulate additional employee stock-based awards data over time and as we incorporate market data related to our common stock, we may calculate significantly different volatilities and expected lives, which could materially impact the valuation of our stock-based awards and the stock-based compensation expense that we will recognize in future periods. stock-based compensation expense is recorded in cost of revenues, research and development expense and selling, general and administrative expense in the consolidated statements of operations.
income taxes we are subject to taxes in the u.s. and in many foreign jurisdictions. significant judgment is required in determining our provision for income taxes, our deferred tax assets and liabilities and any valuation allowance recorded against our net deferred tax assets. we make these estimates and judgments about our future taxable income that are based on assumptions that are consistent with our future plans. tax laws, regulations and administrative practices may be subject to change due to economic or political conditions including fundamental changes to the tax laws applicable to corporate multinationals. the u.s., many countries in the european union and a number of other countries are actively considering changes in this regard. as of december 31, 2020, we had recorded a full valuation allowance on our net u.s. deferred tax assets because we expect that it is more likely than not that our u.s. deferred tax assets will not be realized. should the actual amounts differ from our estimates, the amount of our valuation allowance could be materially impacted.
furthermore, significant judgment is required in evaluating our tax positions. in the ordinary course of business, there are many transactions and calculations for which the ultimate tax settlement is uncertain. as a result, we recognize the effect of this uncertainty on our tax attributes or taxes payable based on our estimates of the eventual outcome. these effects are recognized when, despite our belief that our tax return positions are supportable, we believe that it is likely that some of those positions may not be fully sustained upon review by tax authorities. we are required to file income tax returns in the u.s. and various foreign jurisdictions, which requires us to interpret the applicable tax laws and regulations in effect in such jurisdictions. such returns are subject to audit by the various federal, state and foreign taxing authorities, who may disagree with respect to our tax positions. we believe that our consideration is adequate for all open audit years based on our assessment of many factors, including past experience and interpretations of tax law. we review and update our estimates in light of changing facts and circumstances, such as the closing of a tax audit, the lapse of a statute of limitations or a change in estimate. to the extent that the final tax outcome of these matters differs from our expectations, such differences may impact income tax expense in the period in which such determination is made. the eventual impact on our income tax expense depends in part if we still have a valuation allowance recorded against our deferred tax assets in the period that such determination is made.
principles of consolidation the consolidated financial statements reflect our accounts and operations and those of our subsidiaries in which we have a controlling financial interest. in accordance with the provisions of asc 810, consolidation, we consolidate any variable interest entity ("vie") of which we are the primary beneficiary. we form vies with our financing fund investors in the ordinary course of business in order to facilitate the funding and monetization of certain attributes associated with our solar energy systems and leases under our direct vehicle leasing programs. the typical condition for a controlling financial interest ownership is holding a majority of the voting interests of an entity; however, a controlling financial interest may also exist in entities, such as vies, through arrangements that do not involve controlling voting interests. asc 810 requires a variable interest holder to consolidate a vie if that party has the power to direct the activities of the vie that most significantly impact the vie's economic performance and the obligation to absorb losses of the vie that could potentially be significant to the vie or the right to receive benefits from the vie that could potentially be significant to the vie. we do not consolidate a vie in which we have a majority ownership interest when we are not considered the primary beneficiary. we have determined that we are the primary beneficiary of all the vies. we evaluate our relationships with all the vies on an ongoing basis to ensure that we continue to be the primary beneficiary. all intercompany transactions and balances have been eliminated upon consolidation.
noncontrolling interests and redeemable noncontrolling interests noncontrolling interests and redeemable noncontrolling interests represent third-party interests in the net assets under certain funding arrangements, or funds, that we enter into to finance the costs of solar energy systems and vehicles under operating leases. we have determined that the contractual provisions of the funds represent substantive profit sharing arrangements. we have further determined that the methodology for calculating the noncontrolling interest and redeemable noncontrolling interest balances that reflects the substantive profit sharing arrangements is a balance sheet approach using the hypothetical liquidation at book value ("hlbv") method. we, therefore, determine the amount of the noncontrolling interests and redeemable noncontrolling interests in the net assets of the funds at each balance sheet date using the hlbv method, which is presented on the consolidated balance sheet as noncontrolling interests in subsidiaries and redeemable noncontrolling interests in subsidiaries. under the hlbv method, the amounts reported as noncontrolling interests and redeemable noncontrolling interests in the consolidated balance sheet represent the amounts the third parties would hypothetically receive at each balance sheet date under the liquidation provisions of the funds, assuming the net assets of the funds were liquidated at their recorded amounts determined in accordance with gaap and with tax laws effective at the balance sheet date and distributed to the third parties. the third parties' interests in the results of operations of the funds are determined as the difference in the noncontrolling interest and redeemable noncontrolling interest balances in the consolidated balance sheets between the start and end of each reporting period, after taking into account any capital transactions between the funds and the third parties. however, the redeemable noncontrolling interest balance is at least equal to the redemption amount. the redeemable noncontrolling interest balance is presented as temporary equity in the mezzanine section of the consolidated balance sheet since these third parties have the right to redeem their interests in the funds for cash or other assets. for certain funds, there may be significant fluctuations in net income (loss) attributable to noncontrolling interests and redeemable noncontrolling interests in subsidiaries due to changes in the liquidation provisions as time-based milestones are reached.
results of operations effects of covid-19
the covid-19 pandemic impacted our business and financial results in 2020.
the temporary suspension of production at our factories during the first half of 2020 caused production limitations that, together with reduced or closed government and third party partner operations in the year, negatively impacted our deliveries and deployments in 2020. while we resumed operations at all of our factories worldwide, our temporary suspension at our factories resulted in idle capacity charges as we still incurred fixed costs such as depreciation, certain payroll related expenses and property taxes. as part of our response strategy to the business disruptions and uncertainty around macroeconomic conditions caused by the covid-19 pandemic, we instituted cost reduction initiatives across our business globally to be commensurate to the scope of our operations while they were scaled back in the first half of 2020. this included temporary labor cost reduction measures such as employee furloughs and compensation reductions. additionally, we suspended non-critical operating spend and opportunistically renegotiated supplier and vendor arrangements. as part of various governmental responses to the pandemic granted to companies globally, we received certain payroll related benefits which helped to reduce the impact of the covid-19 pandemic on our financial results. such payroll related benefits related to our direct headcount have been primarily netted against our disclosed idle capacity charges and they marginally reduced our operating expenses. the impact of the idle capacity charges incurred during the first half of 2020 were almost entirely offset by our cost savings initiatives and payroll related benefits.
revenues year ended december 31,                               2020 vs. 2019 change                      2019 vs. 2018 change services and other                                         2,306                    2,226                    1,391            80                       4   %           835                      60   %
total automotive &amp; services and other                 29,542                   23,047                   19,906         6,495                      28   %         3,141                      16   %
segment revenue energy generation and storage segment revenue              1,994                    1,531                    1,555           463                      30   %           (24     )                -2   %
automotive & services and other segment automotive sales revenue includes revenues related to cash deliveries of new model s, model x, model 3 and model y vehicles, including access to our supercharger network, internet connectivity, fsd features and over-the-air software updates, as well as sales of regulatory credits to other automotive manufacturers. cash deliveries are vehicles that are not subject to lease accounting. our revenue from regulatory credits fluctuates depending on when a contract is executed with a buyer and when the credits are delivered.
automotive leasing revenue includes the amortization of revenue for vehicles under direct operating lease agreements as well as those sold with resale value guarantees accounted for as operating leases under lease accounting. we began offering direct leasing for model 3 vehicles in the second quarter of 2019 and we began offering direct leasing for model y vehicles in the third quarter of 2020. additionally, automotive leasing revenue includes direct sales-type leasing programs where we recognize all revenue associated with the sales-type lease upon delivery to the customer, which we introduced in volume during the third quarter of 2020.
services and other revenue consists of non-warranty after-sales vehicle services, sales of used vehicles, retail merchandise, sales by our acquired subsidiaries to third party customers and vehicle insurance revenue.
automotive sales revenue increased $6.23 billion, or 31%, in the year ended december 31, 2020 as compared to the year ended december 31, 2019, primarily due to an increase of 129,268 model 3 and model y cash deliveries despite production limitations as a result of temporary suspension of production at the fremont factory and gigafactory nevada during the first half of 2020. we were able to increase deliveries year over year from production ramping at both gigafactory shanghai and the fremont factory. there was also an increase of $986 million from additional sales of regulatory credits to $1.58 billion in the year ended december 31, 2020. additionally, due to pricing adjustments we made to our vehicle offerings during the year ended december 31, 2019, we estimated that there was a greater likelihood that customers would exercise their buyback options and adjusted our sales return reserve on vehicles previously sold under our buyback options program which resulted in a reduction of automotive sales revenue of $555 million. we made further pricing adjustments that resulted in a similar but smaller reduction of automotive sales revenue of $72 million during the year ended december 31, 2020. the smaller reduction in revenue from pricing adjustments resulted in a positive impact to automotive sales revenue of $483 million year over year. these factors increasing automotive sales revenue were partially offset by a decrease in the combined average selling price of model 3 and model y. despite the inclusion of higher priced model y deliveries in 2020, the combined average selling price of model 3 and model y decreased due to a higher proportion of model 3 standard range variants in our sales mix compared to the prior year. additionally, there was a decrease in automotive sales revenue from 8,669 fewer model s and model x cash deliveries at a relatively consistent combined average selling price in the year ended december 31, 2020 compared to the prior year.
automotive leasing revenue increased $183 million, or 21%, in the year ended december 31, 2020 as compared to the year ended december 31, 2019, primarily due to an increase in cumulative vehicles under our direct operating lease program and the introduction of direct sales-type leasing programs which we began offering in volume during the third quarter of 2020 where we recognize all revenue associated with the sales-type lease upon delivery to the customer. these increases were partially offset by the decreases in automotive leasing revenue associated with our resale value guarantee leasing programs accounted for as operating leases as those portfolios have declined.
services and other revenue increased $80 million, or 4%, in the year ended december 31, 2020 as compared to the year ended december 31, 2019, primarily due to an increase in non-warranty maintenance services revenue as our fleet continues to grow, an increase in retail merchandise revenue and an increase in sales by our acquired subsidiaries to third party customers as we had a partial year of sales in the prior year from our mid-year 2019 acquisitions. these increases were partially offset by a decrease in used vehicle revenue driven by a reduction in non-tesla trade-ins.
energy generation and storage segment energy generation and storage revenue includes sales and leasing of solar energy generation and energy storage products, services related to such products and sales of solar energy systems incentives.
energy generation and storage revenue increased by $463 million, or 30%, in the year ended december 31, 2020 as compared to the year ended december 31, 2019, primarily due to increases in deployments of megapack, solar cash and loan jobs and powerwall, partially offset by a decrease in deployments of powerpack and reduced average selling prices on our solar cash and loan jobs as a result of our low cost solar strategy. powerpack deployments have decreased following the introduction of our megapack product, which we began deploying in late 2019.
cost of revenues and gross margin year ended december 31,                                   2020 vs. 2019 change                      2019 vs. 2018 change cost of revenues automotive sales                                                  $19,696                  $15,939                  $13,686            $3,757                      24   %        $2,253                      16   %
total automotive cost of revenues                                  20,259                   16,398                   14,174             3,861                      24   %         2,224                      16   %
services and other                                                  2,671                    2,770                    1,880               (99   )                  -4   %           890                      47   %
total automotive &amp; services and other                          22,930                   19,168                   16,054             3,762                      20   %         3,114                      19   %
segment cost of revenues energy generation and storage segment                               1,976                    1,341                    1,365               635                      47   %           (24   )                  -2   %
total cost of revenues                                            $24,906                  $20,509                  $17,419            $4,397                      21   %        $3,090                      18   %
gross profit total automotive                                      $6,977                   $4,423                   $4,341
gross profit total automotive &amp; services and other             $6,612                   $3,879                   $3,852
segment gross margin total automotive &amp; services and other                 22    %                  17    %                  19   %
segment gross profit energy generation and storage segment                    $18                     $190                     $190
gross margin energy generation and storage segment                      1    %                  12    %                  12   %
total gross profit                                                 $6,630                   $4,069                   $4,042
automotive & services and other segment cost of automotive sales revenue includes direct parts, material and labor costs, manufacturing overhead, including depreciation costs of tooling and machinery, shipping and logistic costs, vehicle connectivity costs, allocations of electricity and infrastructure costs related to our supercharger network and reserves for estimated warranty expenses. cost of automotive sales revenues also includes adjustments to warranty expense and charges to write down the carrying value of our inventory when it exceeds its estimated net realizable value and to provide for obsolete and on-hand inventory in excess of forecasted demand.
cost of automotive leasing revenue includes the amortization of operating lease vehicles over the lease term, cost of goods sold associated with direct sales-type leases which were introduced in volume in the third quarter of 2020, as well as warranty expenses related to leased vehicles. cost of automotive leasing revenue also includes vehicle connectivity costs and allocations of electricity and infrastructure costs related to our supercharger network for vehicles under our leasing programs.
cost of services and other revenue includes costs associated with providing non-warranty after-sales services, costs to acquire and certify used vehicles, costs for retail merchandise, and costs to provide vehicle insurance. cost of services and other revenue also includes direct parts, material and labor costs and manufacturing overhead associated with the sales by our acquired subsidiaries to third party customers.
cost of automotive sales revenue increased $3.76 billion, or 24%, in the year ended december 31, 2020 as compared to the year ended december 31, 2019, primarily due to an increase of 129,268 model 3 and model y cash deliveries. due to pricing adjustments we made to our vehicle offerings during the year ended december 31, 2019, we estimated that there was a greater likelihood that customers would exercise their buyback options and if customers elect to exercise the buyback option, we expect to be able to subsequently resell the returned vehicles, which resulted in a reduction of cost of automotive sales revenue of $451 million. we made further pricing adjustments that resulted in a similar but smaller reduction of cost of automotive sales revenue of $42 million during the year ended december 31, 2020. additionally, there was an increase to cost of automotive sales revenue from idle capacity charges of $213 million as a result of temporary suspension of production at the fremont factory and gigafactory nevada during the first half of 2020. these factors increasing cost of automotive sales revenue were partially offset by a decrease in average model 3 costs per unit due to lower material, manufacturing, freight and duty costs from localized procurement and manufacturing in china and a higher sales mix of lower end trims, as well as a decrease of 8,669 model s and model x cash deliveries in the year ended december 31, 2020 compared to the prior year.
cost of automotive leasing revenue increased $104 million, or 23%, in the year ended december 31, 2020 as compared to the year ended december 31, 2019, primarily due to an increase in cumulative vehicles under our direct operating lease program and the introduction of direct sales-type leasing programs which we began offering in volume during the third quarter of 2020 where we recognize all cost of revenue associated with the sales-type lease upon delivery to the customer. these increases were partially offset by the decreases in cost of automotive lease revenue associated with our resale value guarantee leasing programs which are accounted for as operating leases as those portfolios have declined.
cost of services and other revenue decreased $99 million, or 4%, in the year ended december 31, 2020 as compared to the year ended december 31, 2019, primarily due to a decrease in used vehicle cost of revenue driven by a reduction in non-tesla trade-ins, partially offset by increases in non-warranty maintenance services as our fleet continues to grow and an increase in costs of retail merchandise as our sales have increased.
gross margin for total automotive increased from 21% to 26% in the year ended december 31, 2020 as compared to the year ended december 31, 2019, primarily due to an improvement of model 3 gross margin primarily from lower material, manufacturing, freight and duty costs from localized procurement and manufacturing in china, partially offset by a decrease in the average selling price of model 3 due to a higher proportion of model 3 standard range variants in our sales mix compared to the prior year. additionally, there was an increase of $986 million in sales of regulatory credits and a positive impact from model y deliveries in 2020 as model y gross margin was higher than our prior year total automotive gross margin. these increases were partially offset by idle capacity charges of $213 million as a result of a temporary suspension of production at the fremont factory and gigafactory nevada during the first half of 2020.
gross margin for total automotive & services and other segment increased from 17% to 22% in the year ended december 31, 2020 as compared to the year ended december 31, 2019, primarily due to the automotive gross margin impacts discussed above and a lower proportion of services and other, which operated at a lower gross margin than our automotive business, within the segment in the year ended december 31, 2020. additionally, there was an improvement in our non-warranty maintenance services gross margin due to increased operational efficiencies despite additional costs from ramping service centers to accommodate a larger deployed fleet and an improvement in our used vehicle sales gross margin.
energy generation and storage segment cost of energy generation and storage revenue includes direct and indirect material and labor costs, warehouse rent, freight, warranty expense, other overhead costs and amortization of certain acquired intangible assets. cost of energy generation and storage revenue also includes charges to write down the carrying value of our inventory when it exceeds its estimated net realizable value and to provide for obsolete and on-hand inventory in excess of forecasted demand. in agreements for solar energy system and ppas where we are the lessor, the cost of revenue is primarily comprised of depreciation of the cost of leased solar energy systems, maintenance costs associated with those systems and amortization of any initial direct costs.
cost of energy generation and storage revenue increased by $635 million, or 47%, in the year ended december 31, 2020 as compared to the year ended december 31, 2019, primarily due to increases in deployments of megapack, higher costs from temporary manufacturing underutilization of our solar roof ramp, increases in deployments of powerwall and idle capacity charges of $20 million as a result of temporary suspension of production at gigafactory new york during the first half of 2020. these increases were partially offset by a decrease in deployments of powerpack.
gross margin for energy generation and storage decreased from 12% to 1% in the year ended december 31, 2020 as compared to the year ended december 31, 2019 primarily due to a higher proportion of solar roof in our overall energy business which operated at lower gross margins as a result of temporary manufacturing underutilization during product ramp. additionally, there were lower gross margins in our solar cash and loan business from reduced average selling prices as a result of our low cost solar strategy, partially offset by lower materials and manufacturing costs.
research and development expense year ended december 31,                             2020 vs. 2019 change                    2019 vs. 2018 change research and development             $1,491                $1,343                $1,460            $148                      11   %   $(117       )                  -8   %
as a percentage of revenues               5    %                5    %                7   %
research and development ("r&d") expenses consist primarily of personnel costs for our teams in engineering and research, manufacturing engineering and manufacturing test organizations, prototyping expense, contract and professional services and amortized equipment expense.
r&d expenses increased $148 million, or 11%, in the year ended december 31, 2020 as compared to the year ended december 31, 2019. the increase was primarily due to a $62 million increase in expensed materials as we continue to expand our product roadmap, $61 million increase in stock-based compensation expense primarily related to the issuance of equity awards in fiscal year 2020 at higher grant date fair values due to our increased share price, $20 million increase in facilities, freight and depreciation expenses and a $20 million increase in employee and labor related expenses.
r&d expenses as a percentage of revenue decreased from 5.5% to 4.7% in the year ended december 31, 2020 as compared to the year ended december 31, 2019. the decrease is primarily an increase in total revenues from expanding sales, partially offset by an increase in our r&d expenses as detailed above.
selling, general and administrative expense year ended december 31,                             2020 vs. 2019 change                    2019 vs. 2018 change as a percentage of revenues                      10    %               11    %               13   %
selling, general and administrative ("sg&a") expenses generally consist of personnel and facilities costs related to our stores, marketing, sales, executive, finance, human resources, information technology and legal organizations, as well as fees for professional and contract services and litigation settlements.
sg&a expenses increased $499 million, or 19%, in the year ended december 31, 2020 as compared to the year ended december 31, 2019. the increase is primarily due to an increase of $625 million in stock-based compensation expense, of which $542 million was attributable to the 2018 ceo performance award. we recorded stock-based compensation expense of $838 million in the year ended december 31, 2020 for the 2018 ceo performance award compared to $296 million in the prior year. of the expense recorded in fiscal year 2020, $232 million was due to cumulative catch-up expense for the service provided from the grant date when three operational milestones under such award were considered probable of being met and the remaining unamortized expense of $357 million for the first four tranches were recognized upon vesting as the first four market capitalization milestones were achieved (see note 14, equity incentive plans, to the consolidated financial statements included elsewhere in this annual report on form 10-k). the remaining stock-based compensation expense increase of $83 million attributable to other directors and employees is primarily related to the issuance of equity awards in fiscal year 2020 at higher grant date fair values due to our increased share price. the increase in stock-based compensation was partially offset by a decrease of $90 million in customer promotional costs, facilities-related expenses and sales and marketing activities. additionally, there was a reduction to operating expenses for costs previously incurred in the amount of $43 million for the settlement in part of the securities litigation relating to the solarcity acquisition (see note 16, commitments and contingencies-legal proceedings-securities litigation relating to the solarcity acquisition, to the consolidated financial statements included elsewhere in this annual report on form 10-k).
sg&a expenses as a percentage of revenue decreased from 11% to 10% in year ended december 31, 2020 as compared to the year ended december 31, 2019. the decrease is primarily from an increase in total revenues from expanding sales, partially offset by an increase in our sg&a expenses as detailed above.
restructuring and other year ended december 31,                          2020 vs. 2019 change                2019 vs. 2018 change as a percentage of revenues       0         %               1    %              1   %
interest expense year ended december 31,                          2020 vs. 2019 change                    2019 vs. 2018 change as a percentage of revenues       2         %         3         %         3         %
interest expense increased by $63 million, or 9%, in the year ended december 31, 2020 as compared to the year ended december 31, 2019, primarily due to $105 million of losses on extinguishment of debt in fiscal year 2020 from early conversions on our convertible senior notes, partially offset by a decrease in interest expense due to a decrease in our weighted average interest rate as compared to the prior year and an increase of $17 million in the amount of interest we capitalized from the consolidated statements of operations to property, plant and equipment on the consolidated balance sheets. increased capitalization results in lower interest expense. the amount of interest we capitalize is driven by our construction in progress balance, which increased year-over-year due to our construction and expansion of multiple factories.
other income (expense), net year ended december 31,                              2020 vs. 2019 change                     2019 vs. 2018 change as a percentage of revenues       0         %               0    %              0   %
other (expense) income, net, consists primarily of foreign exchange gains and losses related to our foreign currency-denominated monetary assets and liabilities and changes in the fair values of our fixed-for-floating interest rate swaps. we expect our foreign exchange gains and losses will vary depending upon movements in the underlying exchange rates.
other (expense) income, net, changed unfavorably by $167 million in the year ended december 31, 2020 as compared to the year ended december 31, 2019. the unfavorable change was primarily due to fluctuations in foreign currency exchange rates such as the u.s. dollar depreciating greater than 5% against the euro and the chinese yuan in 2020 compared to an appreciation of 2% and 1% against the same currencies in the prior year, respectively.
provision for income taxes year ended december 31,                           2020 vs. 2019 change                    2019 vs. 2018 change our provision for income taxes increased by $182 million, or 165%, in the year ended december 31, 2020 as compared to the year ended december 31, 2019. the increase was primarily due to the substantial increases in taxable profits in our foreign jurisdictions year-over-year.
net income (loss) attributable to noncontrolling interests and redeemable noncontrolling interests year ended december 31,                         2020 vs. 2019 change                    2019 vs. 2018 change liquidity and capital resources as of december 31, 2020, we had $19.38 billion of cash and cash equivalents. balances held in foreign currencies had a u.s. dollar equivalent of $6.76 billion and consisted primarily of euros, chinese yuan and canadian dollars. our sources of cash are predominantly from our deliveries of vehicles, sales and installations of our energy storage products and solar energy systems, proceeds from debt facilities, proceeds from financing funds and proceeds from equity offerings.
our sources of liquidity and cash flows enable us to fund ongoing operations, research and development projects for new products and technologies including our announced proprietary battery cells, ongoing production and additional manufacturing ramps at existing manufacturing facilities such as the fremont factory, gigafactory nevada, gigafactory shanghai and gigafactory new york, the construction of gigafactory berlin and gigafactory texas, and the continued expansion of our retail and service locations, body shops, mobile service fleet, supercharger network and energy product installation capabilities.
as discussed in and subject to the considerations referenced in part ii, item 7, management's discussion and analysis of financial condition and results of operations-management opportunities, challenges and risks and 2021 outlook-cash flow and capital expenditure trends in this annual report on form 10-k, we currently expect our capital expenditures to be $4.50 to $6.00 billion in 2021 and in each of the next two fiscal years.
we expect that the cash we generate from our core operations will generally be sufficient to cover our future capital expenditures and to pay down our near-term debt obligations, although we may choose to seek alternative financing sources. for example, our local subsidiary has entered into credit facilities to support construction and production at gigafactory shanghai. see note 12, debt, to the consolidated financial statements included elsewhere in this annual report on form 10-k. as always, we continually evaluate our capital expenditure needs and may decide it is best to raise additional capital to fund the rapid growth of our business.
in january 2021, we updated our investment policy to provide us with more flexibility to further diversify and maximize returns on our cash that is not required to maintain adequate operating liquidity. as part of the policy, we may invest a portion of such cash in certain specified alternative reserve assets. thereafter, we invested an aggregate $1.50 billion in bitcoin under this policy. moreover, we expect to begin accepting bitcoin as a form of payment for our products in the near future, subject to applicable laws and initially on a limited basis, which we may or may not liquidate upon receipt. we believe our bitcoin holdings are highly liquid. however, digital assets may be subject to volatile market prices, which may be unfavorable at the time when we want or need to liquidate them.
we have an agreement to spend or incur $5.0 billion in combined capital, operational expenses, costs of goods sold and other costs in the state of new york during the 10-year period beginning april 30, 2018, which we expect to meet through our operations. as we temporarily suspended most of our manufacturing operations at gigafactory new york pursuant to a new york state executive order issued in march 2020 as a result of the covid-19 pandemic, we were granted a one-year deferral of our obligation to be compliant as of april 30, 2020 with our applicable targets under such agreement.
we expect that our current sources of liquidity together with our projection of cash flows from operating activities will provide us with adequate liquidity over at least the next 12 months, even considering the expected levels of capital expenditures in the current and next two fiscal years. a large portion of our future expenditures is to fund our growth, and we can adjust our capital and operating expenditures by operating segment, including future expansion of our product offerings, retail and service locations, body shops, mobile service fleet, and supercharger network. for example, if our near-term manufacturing operations decrease in scale or ramp more slowly than expected, including due to global economic conditions and levels of consumer outlook and spend impacting demand in the worldwide transportation, automotive and energy product industries, we may choose to correspondingly slow the pace of our capital expenditures. we may need or want to raise additional funds in the future, and these funds may not be available to us when we need or want them, or at all. if we cannot raise additional funds when we need or want them, our operations and prospects could be negatively affected.
in addition, we had $2.63 billion of unused committed amounts under our credit facilities and financing funds as of december 31, 2020, some of which are subject to satisfying specified conditions prior to draw-down (such as pledging to our lenders sufficient amounts of qualified receivables, inventories, leased vehicles and our interests in those leases, solar energy systems and the associated customer contracts, our interests in financing funds or various other assets; and contributing or selling qualified solar energy systems and the associated customer contracts or qualified leased vehicles and our interests in those leases into the financing funds). for details regarding our indebtedness and financing funds, refer to note 12, debt, and note 17, variable interest entity arrangements to the consolidated financial statements included elsewhere in this annual report on form 10-k.
summary of cash flows year ended december 31, net cash provided by operating activities          $5,943                $2,405                $2,098
cash flows from operating activities our cash flows from operating activities are significantly affected by our cash investments to support the growth of our business in areas such as research and development and selling, general and administrative and working capital, especially inventory, which includes vehicles in transit. our operating cash inflows include cash from vehicle sales, customer lease payments, customer deposits, cash from sales of regulatory credits and energy generation and storage products. these cash inflows are offset by our payments to suppliers for production materials and parts used in our manufacturing process, operating expenses, operating lease payments and interest payments on our financings.
net cash provided by operating activities increased by $3.54 billion to $5.94 billion during the year ended december 31, 2020 from $2.40 billion during the year ended december 31, 2019. this increase was primarily due to the increase in net income excluding non-cash expenses and gains of $2.82 billion, the decrease in net operating assets and liabilities of $533 million and $188 million of the repayment of our 0.25% convertible senior notes due in 2019 during the three months ended march 31, 2019 (which represents the portion of the repayment that was classified as an operating activity, as this represented an interest payment on the deeply-discounted convertible senior notes). the decrease in our net operating assets and liabilities was mainly driven by a larger increase in accounts payable and accrued liabilities in the year ended december 31, 2020 as compared to the prior year from ramp up in production at the fremont factory and gigafactory shanghai. the decrease in our net operating assets and liabilities was partially offset by a smaller increase in deferred revenue primarily due to delivery of regulatory credits in 2020 under a previous arrangement where we had received payment in advance as of december 31, 2019, a larger increase in operating lease vehicles as model 3 direct leasing was introduced in the second quarter of 2019 and model y direct leasing was introduced in the third quarter of 2020, and a larger increase in accounts receivables of government rebates already passed through to customers.
cash flows from investing activities cash flows from investing activities and their variability across each period related primarily to capital expenditures, which were $3.16 billion for the year ended december 31, 2020, mainly for model y production expansion at the fremont factory, expansion of gigafactory shanghai and construction of gigafactory berlin and gigafactory texas, and $1.33 billion for the year ended december 31, 2019, mainly for gigafactory shanghai construction, model 3 production ramp and model y preparations. the increase in capital expenditures was partially offset by decreases of $32 million in business combinations, net of cash acquired, and $30 million of design, acquisition and installation of solar energy systems when compared to the prior year. additionally, we received $123 million and $46 million, respectively, of government grants in connection with us making certain manufacturing equipment investments at gigafactory shanghai for the years ended december 31, 2020 and 2019, respectively.
cash flows from financing activities cash flows from financing activities during the year ended december 31, 2020 consisted primarily of $12.27 billion from issuance of common stock in public offerings in 2020, net of issuance costs, and $417 million of proceeds from exercise of stock options and other stock issuances. these cash inflows were partially offset by $1.99 billion of cash repayments upon early conversions of our convertible senior notes, $338 million principal repayments of our finance leases, collateralized lease repayments of $240 million and $219 million net payments to financing fund investors. see note 12, debt, and note 2, summary of significant accounting policies, to the consolidated financial statements included elsewhere in this annual report on form 10-k for further details regarding our debt obligations and collateralized borrowings, respectively.
cash flows from financing activities during the year ended december 31, 2019 consisted primarily of $1.82 billion from the issuance of the 2.00% convertible senior notes due in 2024 ("2024 notes"), net of transaction costs, and $848 million from the issuance of common stock, net of underwriting discounts, in registered public offerings, $736 million of net borrowings under loan agreements entered into by certain chinese subsidiaries, $394 million of net borrowings for automotive asset-backed notes and $174 million from the issuance of warrants in connection with the offering of the 2024 notes. these cash inflows were partially offset by a $732 million portion of the repayment of our 0.25% convertible senior notes due in 2019 that was classified as financing activity, a $566 million repayment of our 1.625% convertible senior notes due in 2019, a purchase of convertible note hedges of $476 million in connection with the offering of the 2024 notes and collateralized lease repayments of $389 million.
contractual obligations we are party to contractual obligations involving commitments to make payments to third parties, including certain debt financing arrangements and leases, primarily for stores, service centers, certain manufacturing facilities and certain corporate offices. these also include, as part of our normal business practices, contracts with suppliers for purchases of certain raw materials, components and services to facilitate adequate supply of these materials and services and capacity reservation contracts. the following table sets forth, as of december 31, 2020, certain significant obligations that will affect our future liquidity (in millions):
total   2021                   2022                  2023                  2024                  2025                 thereafter operating lease obligations,         $1,846               $366                  $327                  $279                  $245                  $204            $425
(1)   these amounts represent (i) purchase orders of $5.95 billion issued under binding and enforceable agreements with all vendors as of december 31, 2020 and (ii) $12.37 billion in other estimable purchase obligations pursuant to such agreements, primarily relating to the purchase of lithium-ion cells produced by panasonic at gigafactory nevada, including any additional amounts we may have to pay vendors if we do not meet certain minimum purchase obligations. in cases where no purchase orders were outstanding under binding and enforceable agreements as of december 31, 2020, we have included estimated amounts based on our best estimates and assumptions or discussions with the relevant vendors as of such date or, where applicable, on amounts or assumptions included in such agreements for purposes of discussion or reference. in certain cases, such estimated amounts were subject to contingent events. furthermore, these amounts do not include future payments for purchase obligations that were recorded in accounts payable or accrued liabilities as of december 31, 2020.
(2)   this includes non-recourse debt repayments, including scheduled interest, of $5.16 billion. non-recourse debt refers to debt that is recourse to only assets of our subsidiaries. short-term scheduled interest payments and amortization of convertible senior note conversion features, debt discounts and deferred financing costs for the year ended december 31, 2020 is $342 million. long-term scheduled interest payments and amortization of convertible senior note conversion features, debt discounts and deferred financing costs for the years thereafter is $1.13 billion.
the table above excludes unrecognized tax benefits of $353 million because if recognized, they would be an adjustment to our deferred tax assets.
we offer resale value guarantees or similar buyback terms to certain customers who purchase and finance their vehicles through one of our specified commercial banking partners and certain leasing partners (refer to automotive sales with resale value guarantee or a buyback option in note 2, significant accounting policies, to the consolidated financial statements included elsewhere in this annual report on form 10-k). the maximum amount we could be required to pay under these programs, should customers exercise their resale value guarantees or buyback options, would be $1.84 billion over the next five years, of which $394 million is within a 12-month period from december 31, 2020. we have not included this in the table above as it is unknown how many customers will exercise their options. additionally, we plan to resell any vehicles which are returned to us and therefore, the actual exposure to us is deemed to be limited.
off-balance sheet arrangements during the periods presented, we did not have relationships with unconsolidated entities or financial partnerships, such as entities often referred to as structured finance or special purpose entities, which were established for the purpose of facilitating off-balance sheet arrangements or other contractually narrow or limited purposes.
recent accounting pronouncements see note 2, summary of significant accounting policies, to the consolidated financial statements included elsewhere in this annual report on form 10-k.