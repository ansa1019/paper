item 7. management's discussion and analysis of financial condition and results of operations in addition to historical information, this annual report on form 10-k contains forward-looking statements within the meaning of section 27a of the securities act and section 21e of the exchange act. these statements include, among other things, statements concerning our expectations regarding:
•   variability in sales in certain product categories from year to year and between quarters;
•   the impact of macro-economic and geopolitical factors on our sales;
•   drivers of long-term growth and operating leverage, such as increased sales productivity, functionality and value in our standalone and bundled subscription service offerings;
•   risks and expectations related to acquisitions or sales of assets, including integration issues related to product plans and products, including the acquired technology;
•   expectations regarding uncertain tax benefits and our effective domestic and global tax rates;
•   expectations regarding spending related to real estate and other capital expenditures and to the impact on free cash flows;
•   competition in our markets;
•   other statements regarding our future operations, financial condition and prospects and business strategies; and
these forward-looking statements are subject to certain risks and uncertainties that could cause our actual results to differ materially from those reflected in the forward-looking statements. factors that could cause or contribute to such differences include, but are not limited to, those discussed in this annual report on form 10-k and, in particular, the risks discussed under the heading "risk factors" in part i, item 1a of this annual report on form 10-k and those discussed in other documents we file with the securities and exchange commission (the "sec"). we undertake no obligation to revise or publicly release the results of any revision to these forward-looking statements. given these risks and uncertainties, readers are cautioned not to place undue reliance on such forward-looking statements.
business overview fortinet is a global leader in cybersecurity solutions provided to a wide variety of businesses, such as enterprises, communication service providers and small businesses. our cybersecurity solutions are designed to provide broad visibility and segmentation of the digital attack surface through our integrated security fabric platform, which features automated protection, detection and responses.
•   network security-we derive a majority of product sales from our fortigate network security appliances. our fortigate network security appliances include a broad set of built-in security and networking features and functionalities, including firewall, sd-wan, ssl data leak prevention, vpn, switch and wireless controller and wan acceleration. our network security appliances include our fortios operating system, which provides the foundation for fortigate security functions, and fortiasic integrated circuit, which is designed to accelerate the processing of security and networking functions. our customers may also purchase fortiguard subscription services to receive threat intelligence updates. we provide standard technical support across all of our products through our forticare support services. we also offer services to end-customers including tams, res and professional service consultants for implementations, as well as training services to our end-customers and channel partners.
•   fortinet security fabric-the fortinet security fabric platform is an architectural approach that protects the entire digital attack surface, including network core, endpoints, applications, data centers and private and public cloud. together with our network of fabric-ready partners, the fortinet security fabric platform enables disparate security devices to work together as an integrated, automated and collaborative solution.
•   cloud security-we help customers connect securely to and across their cloud environments by offering security through our virtual firewall and other software products in public and private cloud environments. our cloud security solutions, including our client access security broker solution, forticasb, extend the core capabilities of the fortinet security fabric platform to provide businesses with the same level of cybersecurity and threat intelligence in cloud environments that they receive on their physical networks. fortinet cloud security offerings are available across all major cloud providers, including amazon web services, microsoft azure, google cloud, oracle cloud and ibm cloud.
•   internet of things and operational technology-the proliferation of iot and ot devices has generated new opportunities for us to grow our business. iot and ot have created an environment where data move freely between devices across locations, network environments, remote offices, mobile workers and public cloud environments, making the data difficult to consistently track and secure.
•   we generated cash flows from operating activities of $638.9 million in 2018, an increase of $44.5 million, or 7%, compared to 2017.
our revenue growth was driven by both product and service revenue. on a geographic basis, revenue continues to be diversified globally, which remains a key strength of our business. product revenue grew 17% in 2018. fortigate unit shipments increased year-over-year. sales of non-fortigate products, such as the fortinet security fabric and cloud products and services, also grew significantly. service revenue growth of 23% in 2018 was driven by the strength of our forticare technical support and other service revenue, which combined grew 26%, and fortiguard security subscription revenue, which grew 20%.
in 2018, operating expenses as a percentage of revenue decreased by 5 percentage points compared to 2017. the decrease in operating expenses was primarily driven by a decrease of 4 percentage points in sales and marketing expenses as a percentage of revenue, benefiting from the adoption of accounting standards update ("asu") 2014-09, revenue from contracts with customers (topic 606) ("topic 606") for deferred contract costs, which reduced our commissions expense in absolute dollars and as a percentage of total revenue. in addition, general and administrative expenses as a percentage of revenue decreased by 1 percentage point while research and development expenses as a percentage of revenue remained consistent. our sales and marketing expenses included a benefit of $45.5 million in 2018 from the adoption of topic 606 related to deferred contract costs. under topic 606, we capitalized certain commissions on service contracts and amortize the amount over a certain period. prior to the adoption of topic 606, we expensed the commissions related to these service contracts upfront. excluding this benefit, sales and marketing expense as a percentage of revenue would have been 46% in 2018 compared to 47% in 2017. refer to note 1 to our consolidated financial statements for more information. headcount increased by 15% to 5,845 employees and contractors as of december 31, 2018, up from 5,066 as of december 31, 2017.
business model our sales strategy is based on a two-tier distribution model. we sell to distributors that sell to networking security and enterprise-focused resellers and service providers, who in turn sell to our end-customers. in certain cases, we sell directly to large service providers and major systems integrators. we also offer our products across major cloud providers, and have recognized on-demand revenue from amazon web services and microsoft azure and from customers who deploy our products at a cloud services provider in a bring-your-own-license ("byol") such as from amazon web services, microsoft azure, google cloud, oracle cloud and ibm cloud. in a byol arrangement, a customer purchases a perpetual license from us through our channel partners and deploys the software in a cloud provider's environment. similarly, customers may purchase such a license from us and deploy in their private cloud. while the revenue from such sales is still relatively insignificant, it has increased significantly in recent periods on a percentage basis.
typically, our customers purchase our hardware products and software licenses, as well as our fortiguard security subscription and forticare technical support services. we generally invoice at the time of our sale for the total price of the products and security and technical support services. the invoice is payable within 30 to 45 days. we also invoice certain services on a monthly basis.
our spu hardware architecture is an important part of our approach to network security. the spu includes three lines of proprietary asics: spu cp, spu np and spu soc. the asics are designed for highly efficient execution of computationally intensive tasks, including policy enforcement, threat detection and encryption. as such, asic-based solutions can run many security applications simultaneously without a significant reduction in performance.
key metrics we monitor a number of key metrics, including the key financial metrics set forth below, in order to help us evaluate growth trends, establish budgets, measure the effectiveness of our sales and marketing efforts, and assess operational
efficiencies. the following table summarizes revenue, deferred revenue, billings (non-gaap), net cash provided by operating activities, and free cash flow (non-gaap). we discuss revenue below under "-components of operating results," and we discuss net cash provided by operating activities below under "-liquidity and capital resources." deferred revenue, billings (non-gaap), and free cash flow (non-gaap) are discussed immediately below the following table.
net cash provided by operating activities        $638.9                  $594.4                  $345.7
deferred revenue. our deferred revenue consists of amounts that have been invoiced but that have not yet been recognized as revenue. the majority of our deferred revenue balance consists of the unrecognized portion of service revenue from fortiguard security subscription and forticare technical support service contracts, which is recognized as revenue ratably over the contractual service period. we monitor our deferred revenue balance, growth and the mix of short-term and long-term deferred revenue because it represents a significant portion of revenue and of free cash flow to be recognized in future periods. deferred revenue was $1.69 billion as of december 31, 2018, an increase of $350.5 million, or 26%, from december 31, 2017.
billings (non-gaap). we define billings as revenue recognized in accordance with generally accepted accounting principles in the united states ("gaap") plus the change in deferred revenue from the beginning to the end of the period and adjustments to the deferred revenue balance due to adoption of topic 606 less any deferred revenue balances acquired from business combination(s) during the period. we consider billings to be a useful metric for management and investors because billings drive current and future revenue, which is an important indicator of the health and viability of our business. there are a number of limitations related to the use of billings instead of gaap revenue. first, billings include amounts that have not yet been recognized as revenue and are impacted by the term of security and support agreements. second, we may calculate billings in a manner that is different from peer companies that report similar financial measures. management accounts for these limitations by providing specific information regarding gaap revenue and evaluating billings together with gaap revenue. total billings were $2.15 billion for 2018, an increase of 20% compared to $1.80 billion in 2017.
a reconciliation of revenue, the most directly comparable financial measure calculated and presented in accordance with gaap, to billings is provided below:
free cash flow (non-gaap). we define free cash flow as net cash provided by operating activities minus capital expenditures such as purchases of real estate and other property and equipment. we believe free cash flow to be a liquidity measure that provides useful information to management and investors about the amount of cash generated by the business that, after capital expenditures, can be used for strategic opportunities, including repurchasing outstanding common stock, investing in our business, making strategic acquisitions and strengthening the balance sheet. a limitation of using free cash flow rather than the gaap measure of net cash provided by operating activities is that free cash flow does not represent the total increase or decrease in the cash, cash equivalents and investments balance for the period because it excludes cash provided by or used in other investing and financing activities. management accounts for this limitation by providing information about our capital
expenditures and other investing and financing activities on the face of the consolidated statements of cash flows and under "-liquidity and capital resources" and by presenting cash flows from investing and financing activities in our reconciliation of free cash flows. in addition, it is important to note that other companies, including companies in our industry, may not use free cash flow, may calculate free cash flow in a different manner than we do or may use other financial measures to evaluate their performance, all of which could reduce the usefulness of free cash flow as a comparative measure. a reconciliation of net cash provided by operating activities, the most directly comparable financial measure calculated and presented in accordance with gaap, to free cash flow is provided below:
net cash provided by operating activities   $638.9                $594.4                $345.7
net cash used in investing activities       $(134.9     )         $(76.8      )         $(74.1      )
net cash used in financing activities       $(202.6     )         $(415.6     )         $(105.9     )
components of operating results revenue. we generate the majority of our revenue from sales of our hardware and software products and amortization of amounts included in deferred revenue related to previous sales of fortiguard security subscription and forticare technical support services. we also recognize revenue from cloud business relationships and from providing professional services and training.
•   product revenue. product revenue is primarily generated from sales of our appliances. the majority of our product revenue has been generated by our fortigate product line, and we do not expect this to change in the foreseeable future. product revenue also includes revenue derived from sales of fortigate software licenses and other software. as a percentage of total revenue, we expect that our product revenue may vary from quarter-to-quarter based on certain factors, as discussed below under "-quarterly results of operations," and we expect the trend to continue in 2019.
•   service revenue. service revenue is generated primarily from fortiguard security subscription services and from forticare technical support services. we recognize revenue from fortiguard security subscription and forticare technical support services over the contractual service period. our typical contractual support and subscription term is one to three years and, to a lesser extent, five years. we also generate a small portion of our revenue from professional services and training services, for which we recognize revenue as the services are provided, and cloud-based services, for which we recognize revenue as the services are delivered or on a monthly usage basis. as a percentage of total revenue, we continue to expect service revenue to be higher than product revenue. our service revenue growth rate depends significantly on the growth of our customer base, the expansion of our service bundle offerings, the expansion and introduction of new service offerings and the renewal of service contracts by our existing customers.
•   cost of product revenue. the majority of the cost of product revenue consists of third-party contract manufacturers' costs and the costs of materials used in production. our cost of product revenue also includes supplies, shipping costs, personnel costs associated with logistics and quality control, facility-related costs, excess and obsolete inventory costs, warranty costs, and amortization of intangible assets, if applicable. personnel costs include direct compensation and benefits.
•   cost of service revenue. cost of service revenue is primarily comprised of salaries, benefits and bonuses, as well as stock-based compensation. cost of service revenue also includes third-party repair and contract fulfillment, data center and cloud hosting, supplies and facility-related costs.
gross margin. gross profit as a percentage of revenue, or gross margin, has been and will continue to be affected by a variety of factors, including the average sales price of our products, product costs, the mix of products sold and the mix of revenue between products, software licenses and services and any excess inventory write-offs. service revenue and software licenses have had a positive effect on our total gross margin given the higher gross margins compared to product gross margins. during 2018, service gross margin benefited from renewals and continued sales of hardware bundled with services and subscriptions, growing faster than related expenses. product gross margin was negatively impacted by new product introductions. as a result, the service margin expansion was partially offset by a decline in product gross margin in 2018. overall gross margin in 2019 will be impacted by service and product revenue mix, but we expect it to be comparable to overall gross margin in 2018.
operating expenses. our operating expenses consist of research and development, sales and marketing and general and administrative expenses. personnel costs are the most significant component of operating expenses and consist primarily of salaries, benefits, bonuses, stock-based compensation, and sales commissions, as applicable. we expect personnel costs to continue to increase in absolute dollars as we expand our workforce.
•   research and development. research and development expense consists primarily of personnel costs. additional research and development expenses include asic and system prototypes and certification-related expenses, depreciation of property and equipment and facility-related expenses. the majority of our research and development is focused on both software development and the ongoing development of our hardware platform. we record all research and development expenses as incurred. our research and development teams are primarily located in canada and the united states.
•   sales and marketing. sales and marketing expense is the largest component of our operating expenses and primarily consists of personnel costs. additional sales and marketing expenses include promotional lead generation and other marketing expenses, travel, depreciation of property and equipment and facility-related expenses. we intend to hire additional personnel focused on sales and marketing and expand our sales and marketing efforts worldwide in order to capture market share in the enterprise market.
•   general and administrative. general and administrative expense consists of personnel costs, as well as professional fees, depreciation of property and equipment and software and facility-related expenses. general and administrative personnel include our executive, finance, human resources, information technology and legal organizations. our professional fees principally consist of outside legal, auditing, accounting, tax, information technology and other consulting costs.
interest income. interest income consists of income earned on our cash, cash equivalents and investments. we have historically invested our cash in corporate debt securities, certificates of deposit and term deposits, commercial paper, money market funds, and u.s. government and agency securities.
provision for (benefit from) income taxes. we are subject to income taxes in the united states, as well as other tax jurisdictions or countries in which we conduct business. earnings from our non-u.s. activities are subject to income taxes in a local country, which are generally lower than u.s. tax rates, and may be subject to u.s. income taxes. our effective tax rate differs from the u.s. statutory rate primarily due to foreign income subject to different tax rates than in the u.s., federal research and development tax credit, withholding taxes, excess tax benefits related to stock-based compensation expense and the tax impacts of the 2017 tax act.
in december 2017, the u.s. federal government enacted the 2017 tax act. the 2017 tax act reduced the federal corporate income tax rate from 35% to 21% and created a territorial tax system with a one-time mandatory tax on foreign earnings of u.s. subsidiaries not previously subject to u.s. income tax. in december 2017, the sec staff issued sab 118, which allowed us to record provisional amounts during a measurement period not to extend beyond one year of the enactment date. as a result, we previously provided a provisional estimate of the effect of the 2017 tax act in our financial statements. in the fourth quarter of 2018, we completed our analysis to determine the effect of the 2017 tax act within the measurement period under the sec guidance, and reflected an additional $32.6 million increase related to transition tax in the 2018 income tax expense. we expect further guidance may be forthcoming from the fasb and the sec, as well as regulations, interpretations and rulings from federal and state tax agencies, which could result in additional impacts. we will continue to monitor and assess the impact of the 2017 tax act and the ongoing guidance and accounting interpretations issued in response to the 2017 tax act. our selection of an accounting policy for 2018 with respect to the global intangible low-taxed income ("gilti") tax rules was to treat gilti tax as a current period expense under the period cost method.
our effective tax rate approximates the federal corporate income tax rate and also includes the impact of state taxes, excess tax benefits related to stock-based compensation expense, federal research and development tax credit, foreign withholding tax, nondeductible stock-based compensation expense, foreign income subject to lower tax rates than income earned in the united states, book-to-tax basis differences and the tax impacts of the 2017 tax act.
critical accounting policies and estimates our discussion and analysis of our financial condition and results of operations are based upon our financial statements, which have been prepared in accordance with gaap. these principles require us to make estimates and judgments that affect the reported amounts of assets, liabilities, revenue, cost of revenue and expenses, and related disclosures. we base our estimates on historical experience and on various other assumptions that we believe to be reasonable under the circumstances. to the extent that there are material differences between these estimates and our actual results, our future financial statements will be affected.
we believe that, of the significant accounting policies described in note 1 to our consolidated financial statements included in part ii, item 8 of this annual report on form 10-k, the following accounting policies involve a greater degree of judgment and complexity. accordingly, we believe these are the most critical to fully understand and evaluate our financial condition and results of operations.
revenue recognition on january 1, 2018, we adopted topic 606, revenue from contracts with customers, using the modified retrospective method applied to those contracts which were not completed as of january 1, 2018. results for reporting periods beginning after january 1, 2018 are presented under topic 606, while prior period amounts are not adjusted and continue to be reported under asc topic 605 ("topic 605"), revenue recognition.
beginning in 2018, revenues are recognized when control of goods or services is transferred to our customers, in an amount that reflects the consideration we expect to be entitled to in exchange for those goods or services. prior to 2018, revenue was recognized under topic 605 when all of the following criteria were met: (i) persuasive evidence of an arrangement existed, (ii) delivery has occurred or services have been rendered, (iii) sales price was fixed or determinable and (iv) collectability was reasonably assured.
under topic 606, we determine revenue recognition through the following steps:
•   identification of a contract or contracts with a customer;
•   recognition of revenue when, or as, we satisfy a performance obligation.
our sales contracts typically contain multiple deliverables, such as hardware, software license, security subscription, technical support services and other services, which are generally capable of being distinct and accounted for as separate performance obligations. we evaluated the criteria to be distinct under topic 606 and concluded that the hardware and software licenses were distinct and distinct in the context of a contract from the security subscription and technical support services, as a customer can benefit from the hardware and software licenses without the services and the services are separately identifiable within a contract. we allocate a transaction price to each performance obligation based on relative standalone selling price. we determine standalone selling price based on the historical pricing and discounting practices for those services when sold separately. we determine standalone selling price for a product or service by considering multiple historical factors including, but not limited to, cost of products, gross margin objectives, pricing practices, geographies and the term of a service contract that fall within a reasonably range as a percentage of list price.
under the previous standard, topic 605, revenue from contracts that contain products and services is allocated to each unit of accounting based on an estimated selling price using vendor-specific objective evidence ("vsoe") of selling price, if it existed, or third-party evidence ("tpe") of selling price. if neither vsoe nor tpe of selling price existed for a deliverable, we used our best estimate of selling price for that deliverable. for multiple-element arrangements where software deliverables were included, revenue was allocated to the non-software deliverables and to the software deliverables as a group using the relative estimated selling prices of each of the deliverables in an arrangement based on the estimated selling price hierarchy. the amount allocated to the software deliverables was then allocated to each software deliverable using the residual method when vsoe of fair value existed. if evidence of vsoe of fair value of one or more undelivered elements did not exist, all software allocated revenue was deferred and recognized when delivery of those elements occurred or when fair value was established. when the undelivered element for which we did not have vsoe of fair value was support, revenue for the entire arrangement was recognized ratably over the support period. the same residual method and vsoe of fair value principles applied for our multiple element arrangements that contained only software elements.
deferred contract costs and commission expense beginning in 2018, we recognized commission expense based on topic 606's guidance for contract costs. under this new guidance, we recognize sales commissions related to product sales upfront while sales commissions for service contracts are deferred as deferred contract costs in the consolidated balance sheets and amortized over the applicable amortization period. costs for initial contracts that are not commensurate with renewal commissions are amortized on a straight-line basis over the period of benefit, which we have determined to be five years and which is typically longer than the initial contract term. significant estimates, assumptions, and judgments in accounting for deferred contract costs include, but are not limited to, identification of contract costs, anticipated billings and the expected period of benefit.
valuation of inventory inventory is recorded at the lower of cost or net realizable value. cost is computed using the first-in, first-out method. in assessing the ultimate recoverability of inventory, we make estimates regarding future customer demand, the timing of new product introductions, economic trends and market conditions. if the actual product demand is significantly lower than forecasted, we could be required to record additional inventory write-downs which would be charged to cost of product revenue. any write-downs could have an adverse impact on our gross margins and profitability.
business combinations we include the results of operations of the businesses that we acquire as of the respective dates of acquisition. we allocate the fair value of the purchase price of our business acquisitions to the tangible and intangible assets acquired and liabilities assumed based on their estimated fair values. the excess of the purchase price over the fair values of these identifiable assets and liabilities is recorded as goodwill. we often continue to gather additional information throughout the measurement period, and if we make changes to the amounts recorded, such changes are recorded in the period in which they are identified.
contingent liabilities from time to time, we are involved in disputes, litigation and other legal actions. however, there are many uncertainties associated with any litigation, and these actions or other third-party claims against us may cause us to incur substantial settlement charges, which are inherently difficult to estimate and could adversely affect our results of operations. we review significant new claims and litigation for the probability of an adverse outcome. estimates can change as individual claims develop. the actual liability in any such matters may be materially different from our estimates, which could result in the need to adjust our liability and record additional expenses.
accounting for income taxes we record income taxes using the asset and liability method, which requires the recognition of deferred tax assets and liabilities for the expected future tax consequences of events that have been recognized in our financial statements or tax returns. in addition, deferred tax assets are recorded for the future benefit of utilizing net operating losses and research and development credit carryforwards. deferred tax assets and liabilities are measured using the currently enacted tax rates that apply to taxable income in effect for the years in which those tax assets and liabilities are expected to be realized or settled. valuation allowances are provided when necessary to reduce deferred tax assets to the amount expected to be realized.
we recognize tax benefits from an uncertain tax position only if it is more likely than not, based on the technical merits of the position that the tax position will be sustained on examination by the tax authorities. the tax benefits recognized in the financial statements from such positions are then measured based on the largest benefit that has a greater than 50% likelihood of being realized upon ultimate settlement.
effective january 1, 2018, the 2017 tax act reduced the federal corporate income tax rate from 35% to 21% and created a territorial tax system with a one-time transition tax on foreign earnings of u.s. subsidiaries not previously subject to u.s. income tax. we expect further guidance may be forthcoming from the fasb and the sec, as well as regulations, interpretations and rulings from federal and state tax agencies, which could result in additional impacts. our selection of an accounting policy for 2018 with respect to the gilti tax rules was to treat gilti tax as a current period expense under the period cost method.
as part of the process of preparing our consolidated financial statements, we are required to estimate our taxes in each of the jurisdictions in which we operate. we estimate actual current tax exposure together with assessing temporary differences resulting from differing treatment of items, such as accruals and allowances not currently deductible for tax purposes. these differences result in deferred tax assets, which are included in our consolidated balance sheets. in general, deferred tax assets represent future tax benefits to be received when certain expenses previously recognized in our consolidated statements of income become deductible expenses under applicable income tax laws, or loss or credit carryforwards are utilized.
in assessing the realizability of deferred tax assets, management considers whether it is more likely than not that some portion or all of the deferred tax assets will be realized. the ultimate realization of deferred tax assets is dependent upon the generation of future taxable income during the periods in which those temporary differences become deductible. we continue to assess the need for a valuation allowance on the deferred tax assets by evaluating both positive and negative evidence that may exist. any adjustment to the valuation allowance on deferred tax assets would be recorded in the consolidated statements of income for the period that the adjustment is determined to be required.
gross profit:
total gross profit                            1,350.8               1,109.6                 937.6
provision for (benefit from) income taxes       (81.3    )             92.6                  10.9
provision for (benefit from) income taxes    (5   )             6                 1
(1) revenue during 2018 under topic 606 (as reported) and 605 (balances without adoption of topic 606) were as follows:
as reported           balances without adoption of topic 606           effect of changeincrease (decrease)
total revenue increased by $306.3 million, or 20%, in 2018 compared to 2017. we continued to experience global diversification of revenue in 2018. revenue from all our regions grew, with emea contributing the largest portion of our revenue growth both on an absolute dollar and on a percentage basis. product revenue increased by $97.2 million, or 17%, in 2018 compared to 2017. product revenue benefited from the adoption of topic 606, primarily related to the change in accounting treatment under topic 606 for some of our software products where revenue from these arrangements can now be recognized upfront instead of ratably over the contracted service term, and partially offset by the lost opportunity to recognize revenue that had been deferred and was written off to equity on the date of adoption. in addition, fortigate unit shipments increased in 2018 compared to 2017 while sales of non-fortigate products, such as the fortinet security fabric hardware and software products, also grew significantly. fortinet security fabric products were the fastest growing products compared to the remainder of our business. service revenue increased by $209.1 million, or 23%, in 2018 compared to 2017. the increase in service revenue was primarily due to the recognition of revenue from our growing deferred revenue balance consisting of fortiguard security subscription and forticare technical support and other contracts sold to a larger customer base, as well as the renewals of similar contracts sold in earlier periods.
(1) cost of revenue and gross margin during 2018 under topic 606 (as reported) and 605 (balances without adoption of topic 606) were as follows:
as reported             balances without adoption of topic 606         effect of changeincrease (decrease)
total gross margin increased by 0.8 percentage points in 2018 compared to 2017, driven by higher margin on higher service revenue. service gross margin increased by 1.3 percentage points during 2018 as compared to 2017, due to the strength of our forticare technical support and other revenue growing 26%. fortiguard security subscription revenue grew 20%, during 2018 compared to 2017, which outpaced the increase in the related personnel costs and headcount growth, resulting in higher margin. cost of service revenue was comprised primarily of personnel costs. product gross margin decreased by 0.9 percentage points in 2018 compared to 2017, as we continued to transition to our new product introductions. total cost of product revenue was comprised primarily of direct and indirect cost of products sold, inventory reserves and other charges.
(1) operating expenses during 2018 under topic 606 (as reported) and 605 (balances without adoption of topic 606) were as follows:
as reported           balances without adoption of topic 606       effect of changeincrease (decrease)
research and development research and development expense increased by $33.9 million, or 16%, in 2018 compared to 2017, primarily due to an increase of $28.7 million in personnel costs as a result of increased headcount to support the development of new products and continued enhancements of our existing products. in addition, depreciation and other occupancy-related costs increased by $2.8 million and product development costs, such as third-party testing and prototypes, increased by $1.2 million. we intend to continue to invest in our research and development organization, and expect research and development expense to increase in absolute dollars in 2019.
sales and marketing sales and marketing expense increased by $81.3 million, or 12%, in 2018 compared to 2017, primarily due to an increase of $64.9 million in personnel costs, including higher stock-based compensation expense of $17.6 million. sales and marketing headcount increased in order to drive market share gains globally. the increase in personnel costs included a benefit of $45.5 million from the adoption of topic 606 related to deferred contract costs. under topic 606, we capitalized certain commissions on service contracts and amortize the amount over a certain period. prior to the adoption of this new standard, we expensed the commissions related to these service contracts. our sales and marketing expense would have increased by $126.8 million, or 18%, under topic 605. refer to note 1 in our notes to the consolidated financial statements for more information. in addition, depreciation expense and other occupancy-related expense increased by $6.7 million, travel and entertainment expense increased by $6.4 million and supplies expense increased by $2.0 million. as a percentage of total revenue, sales and marketing expense decreased primarily due to the benefit from the new accounting standard on deferred contract costs. excluding this benefit, sales and marketing expense as a percentage of revenue would have been 46% of total revenue. we intend to continue to make investments in our sales resources and infrastructure and marketing strategy, which are critical to support growth, and expect sales and marketing expense to increase in absolute dollars in 2019.
general and administrative general and administrative expense increased by $5.1 million, or 6%, in 2018 compared to 2017. personnel costs increased by $9.8 million as we continued to increase headcount in order to support our expanding business. the increase in expense was partially offset by a decrease in litigation costs of $1.2 million and a decrease in professional fees of $0.6 million. certain facilities, depreciation, and information technology costs are allocated to other organizations based on headcount. we expect general and administrative expense to increase in absolute dollars in 2019.
operating income and margin we generated operating income of $231.0 million in 2018, an increase of $121.2 million, or 110%, compared to $109.8 million in 2017. the improvement in operating income included the benefit from the adoption of topic 606, along with revenue growth outpacing expense growth. operating income as a percentage of revenue increased to 13% in 2018 compared to 7% in 2017. the increase in operating margin is primarily due to a decline in sales and marketing expenses as a percentage of total revenue to 43% in 2018 compared to 47% in 2017. excluding the benefit from the adoption of topic 606, sales and marketing expense as a percentage of revenue would have been 46% of total revenue. the adoption of topic 606 resulted in an improvement of 3 percentage points in our operating margin. in addition, general and administrative expenses as a percentage of total revenue decreased by 1 percentage point and gross margin improved by 0.8 percentage points, contributing to the improvement in operating margin. research and development expenses as a percentage of revenue remained consistent.
provision for (benefit from) income taxes year ended december 31,                        change                % change
provision for (benefit from) income taxes   $(81.3      )               $92.6              $(173.9     )         (188   )%
(1) provision for income taxes during 2018 under topic 606 (as reported) and 605 (balances without adoption of topic 606) were as follows:
as reported             balances without adoption of topic 606             (increase) decrease
benefit from income taxes   $(81.3      )           $(92.2                        )                    $10.9
our provision for income taxes for 2018 reflects an effective tax rate benefit of (32)%, compared to an effective tax rate provision of 75% for 2017. the benefit from income taxes for 2018 was comprised primarily of impacts related to the 2017 tax act including a benefit of $164.0 million from the realignment of our tax structure and operations that resulted in a book-to-tax basis difference from previously taxed off-shore deferred revenue. these benefits were partially offset by a $32.6 million increase in the transition tax for finalization of the provisional estimates under sab 118, a $20.5 million tax expense for the impact of the gilti and a $29.6 million of tax expense related to u.s. federal and state taxes, other foreign income taxes, foreign withholding taxes and a decrease in tax reserves.
effective january 1, 2018, the 2017 tax act reduced the federal corporate income tax rate from 35% to 21% and created a territorial tax system with a one-time mandatory tax on foreign earnings of u.s. subsidiaries not previously subject to u.s. income tax. under gaap, changes in tax rates and tax law are accounted for in the period of enactment and deferred tax assets and liabilities are measured at the enacted tax rate. in december 2017, the sec staff issued sab 118, which allowed us to record provisional amounts during a measurement period not to extend beyond one year of the enactment date. as a result, we previously provided a provisional estimate of the effect of the 2017 tax act in our financial statements. in the fourth quarter of 2018, we completed our analysis to determine the effect of the 2017 tax act within the measurement period under the sec guidance, and reflected an increase of an additional $32.6 million related to the transition tax in the 2018 income tax expense. we expect further guidance may be forthcoming from the fasb and the sec, as well as regulations, interpretations and rulings from federal and state tax agencies, which could result in additional impacts.
in 2017, the effective tax rate was 75%, primarily resulting from the deferred tax assets remeasurement and a one-time transition tax due to the 2017 tax act. excluding the tax impacts from the 2017 tax act, our 2017 effective tax rate would have been 24%.
total revenue increased by $219.5 million, or 17%, in 2017 compared to 2016. we continued to experience global diversification of revenue in 2017. revenue from all our regions grew, with the americas contributing the largest portion of our revenue growth both on an absolute dollar and on a percentage basis. product revenue increased by $29.1 million, or 5%, in 2017 compared to 2016. the increase in product revenue was primarily driven by greater sales volume in our fortigate product family across all product categories. sales of non-fortigate products, such as the fortinet security fabric hardware and software products, and services, also grew significantly. service revenue increased by $190.4 million, or 26%, in 2017 compared to 2016. the increase in service revenue was primarily due to the recognition of revenue from our growing deferred revenue balance consisting of fortiguard security subscription and forticare technical support contracts sold to a larger customer base, as well as the renewals of similar contracts sold in earlier periods.
total gross margin increased by 0.7 percentage points in 2017 compared to 2016, driven by higher margin on service revenue. during 2017, service gross margin benefited from the shift to higher-margin service revenue. product gross margin was negatively impacted by longer term deals, resulting in lower product revenue recognized in 2017 and higher deferred revenue for services that was expected to be recognized in future periods, and as a result of product costs being recognized upon shipment. as a result, the service margin expansion was partially offset by a decline in product gross margin in 2017. total cost of product revenue was comprised primarily of direct and indirect cost of products sold, inventory reserves and other charges. cost of service revenue was comprised primarily of personnel costs.
research and development research and development expense increased by $27.5 million, or 15%, in 2017 compared to 2016, primarily due to an increase of $17.6 million in personnel costs as a result of increased headcount to support the development of new products and continued enhancements of our existing products. in addition, product development costs, such as third-party testing and prototypes, increased by $6.2 million and depreciation and other occupancy-related costs increased by $3.1 million.
sales and marketing sales and marketing expense increased by $74.5 million, or 12%, in 2017 compared to 2016, primarily due to an increase of $55.1 million in personnel costs as we continued to increase our sales and marketing headcount in order to drive continued market share gains globally. marketing-related expense increased by $11.9 million as we invested significantly in marketing programs to drive broader market awareness, build lead generation programs and accelerate pipeline. in addition, depreciation expense and other occupancy-related expense increased by $6.8 million. as a percentage of total revenue, sales and marketing expense decreased as revenue grew at a higher pace compared to personnel costs.
general and administrative general and administrative expense increased by $6.8 million, or 8%, in 2017 compared to 2016. personnel costs increased by $8.5 million as we continued to increase headcount in order to support our expanding business. professional fees increased by $10.6 million, primarily due to the implementation of a new revenue recognition system and a litigation settlement expense of $1.8 million. the increase in expense was partially offset by a decrease in third-party costs of $13.4 million related to the substantial completion of our erp system implementation in 2016.
our effective tax rate was 75% for 2017, compared to an effective tax rate of 25% for 2016. the provision for income taxes for 2017 was comprised primarily of u.s. federal and state taxes, other foreign income taxes, foreign withholding taxes, an increase in tax reserves, remeasurement of deferred tax assets and a one-time transition tax.
in december 2017, the u.s. federal government enacted the 2017 tax act. the 2017 tax act reduced the federal corporate income tax rate from 35% to 21% effective january 1, 2018 and created a territorial tax system with a one-time mandatory tax on foreign earnings of u.s. subsidiaries not previously subject to u.s. income tax. under gaap, changes in tax rates and tax law are accounted for in the period of enactment and deferred tax assets and liabilities are measured at the enacted tax rate.
the sec staff has issued sab 118, which provides guidance on accounting for the tax effects of the 2017 tax act. sab 118 provides a measurement period that should not extend beyond one year from the 2017 tax act enactment date for companies to complete the accounting under asc 740. in accordance with sab 118, a company must reflect the income tax effects of those aspects of the 2017 tax act for which the accounting under asc 740 is complete. to the extent that a company's accounting for certain income tax effects of the 2017 tax act is incomplete but it is able to determine a reasonable estimate, it must record a provisional estimate in the financial statements. if a company cannot determine a provisional estimate to be included in the financial statements, it should continue to apply asc 740 on the basis of the provisions of the tax laws that were in effect immediately before the enactment of the 2017 tax act.
the increase in the effective tax rate in 2017 was primarily due to the deferred tax assets remeasurement and a one-time transition tax due to the 2017 tax act. excluding the tax impact from the 2017 tax act, the 2017 effective tax rate would have been 24%, which was relatively consistent with 2016. in 2016, due to the early adoption of asu 2016-09, approximately $10.8 million of excess tax benefits were recognized in the income tax provision. in 2017, $13.5 million of excess tax benefits was included in the income tax provision.
quarterly results of operations the following table sets forth our unaudited quarterly statements of income data for the last eight quarters. the information for each of these quarters has been prepared on the same basis as the audited annual financial statements included elsewhere in this annual report and, in the opinion of management, includes all adjustments, which includes only normal recurring adjustments, necessary for the fair presentation of the results of operations for these periods. this data should be read in conjunction with our audited consolidated financial statements and related notes included elsewhere in this annual report. these quarterly operating results are not necessarily indicative of our operating results for any future period.
total gross profit                              378.5                342.3                328.2                301.8                311.2                280.6                267.8                250.0
provision for (benefit from) income taxes       (90.5    )            11.9                  2.2                 (4.9    )            74.0                 11.3                  9.9                 (2.6    )
seasonality, cyclicality and quarterly revenue trends our quarterly results reflect a pattern of increased customer buying at year-end, which has positively impacted billings and product revenue activity in the fourth quarter. in the first quarter, we generally experience lower sequential customer buying, followed by an increase in buying in the second quarter. the third quarter is often consistent with the second quarter. although these seasonal factors are common in the technology sector, historical patterns should not be considered a reliable indicator of our future sales activity or performance. on a quarterly basis, we have usually generated the majority of our product revenue in the final month of each quarter and a significant amount in the last two weeks of each quarter. we believe this is due to customer buying patterns typical in this industry.
consistent with the seasonality note above, our total quarterly revenue over the past eight quarters has generally increased sequentially in each quarter, except in the first and third quarters of 2018 and 2017. product revenue, in each quarter in 2018, increased as compared to the same quarter in 2017, which we believe was due to investments we made in our sales and marketing organizations, continued product innovation and a robust security market. we continue to see a shift from product revenue to higher-margin, recurring service revenue, which is a result of our growing customer base.
total gross margin has fluctuated on a quarterly basis primarily due to seasonality of product sales and seasonality of cost increases. product gross margin varies based on the types of products sold and the average selling prices of our products. in 2018, product gross margin was impacted by new product introductions and the mix of high-end, mid-range and entry-level products. service gross margin benefited from the growth of our customer base and renewals.
liquidity and capital resources as of december 31,
working capital                                     $964.5                  $689.6                  $709.3
net cash provided by operating activities           $638.9                  $594.4                  $345.7
net cash used in investing activities               (134.9    )              (76.8    )              (74.1    )
net cash used in financing activities               (202.6    )             (415.6    )             (105.9    )
liquidity and capital resources may be impacted by our operating activities, as well as by our stock repurchases, real estate and other capital expenditures, proceeds associated with stock option exercises and issuances of common stock under our equity incentive plans, payment of taxes in connection with the net settlement of equity awards and business acquisitions. in recent years, we have received significant capital resources as a result of increases in our deferred revenue and the proceeds from exercise of stock options and purchases under our equity incentive plans. additional increases in deferred revenue may depend on a number of factors including our billing growth rate, service contract renewal rates and length of initial and renewals service contracts. we expect proceeds from the issuance of stock options in future years to be impacted by the increased mix of restricted stock units versus stock options granted and also to vary based on our share price. as of december 31, 2018, $733.8 million remained available for future share repurchase under the repurchase program.
as of december 31, 2018, our cash, cash equivalents and investments of $1.72 billion were invested primarily in corporate debt securities, certificates of deposit and term deposits, commercial paper, money market funds, and u.s. government and agency securities. it is our investment policy to invest excess cash in a manner that preserves capital, provides liquidity and maximizes return without significantly increasing risk. we do not enter into investments for trading or speculative purposes.
the amount of cash, cash equivalents and investments held by our international subsidiaries was $956.6 million as of december 31, 2018. under the 2017 tax act signed into law in december 2017, starting on january 1, 2018, we are no longer subject to federal income tax on earnings remitted from our foreign subsidiaries. we have analyzed our global working capital and cash requirements and the potential tax liabilities attributable to repatriation, and have determined that we will be repatriating certain unremitted foreign earnings which were previously deemed indefinitely reinvested. for those investments from which we were able to make a reasonable estimate of the tax effects of such repatriation, we have recorded a provisional estimate for withholding and state taxes. most of our off-shore cash is located in singapore.
we believe that our existing cash and cash equivalents will be sufficient to meet our anticipated cash needs for at least the next 12 months. our future capital requirements will depend on many factors, including our growth rate, the timing and amount of our planned share repurchases, the timing and extent of spending to support development efforts, the expansion of sales and marketing activities, the introduction of new and enhanced products and services offerings, the continuing market acceptance of our products and our investments in real estate through purchases or long-term leases. historically, we have required capital principally to fund our working capital needs, share repurchases, capital expenditures and acquisition activities. in the event that additional financing is required from outside sources, we may not be able to raise it on terms acceptable to us or at all.
operating activities cash generated by operating activities is our primary source of liquidity. it is primarily comprised of net income, as adjusted for non-cash items, and changes in operating assets and liabilities, including deferred revenue. non-cash adjustments consist primarily of stock-based compensation, amortization of deferred contract costs in connection with the adoption of topic 606, depreciation of property and equipment, amortization of intangible assets and amortization of investment premiums.
our operating activities during 2018 provided $638.9 million in cash as a result of the continued growth of our business and our ability to successfully manage our working capital. changes in operating assets and liabilities primarily resulted from an increase in sales of our fortiguard security subscription and forticare technical support services to new and existing customers, as reflected by an increase in our deferred revenue. our total deferred revenue balance grew 26% as of december 31, 2018 compared to the same period last year to $1.69 billion.
our operating activities during 2017 provided $594.4 million in cash as a result of our continued growth of our business and our ability to successfully manage our working capital. changes in operating assets and liabilities primarily resulted from an increase in sales of our fortiguard security subscription and forticare technical support services to new and existing customers, as reflected by an increase in our deferred revenue, which was partially offset by an increase in accounts receivable. we continued to see a shift from product revenues to higher-margin, recurring service revenues and longer duration contracts. our total revenue grew 17% in 2017 compared to 2016 and our total deferred revenue balance grew 29%.
our operating activities during 2016 provided $345.7 million in cash as a result of our continued growth of our business and the ability to successfully manage our working capital. changes in operating assets and liabilities primarily resulted from an increase in sales of our fortiguard security subscription and forticare technical supports to new and existing customers, as reflected by an increase in our deferred revenue, which was partially offset by an increase in accounts receivable and payments for inventory purchases. we also started to see a shift from product revenues to higher-margin, recurring service revenues. our total revenue grew 26% in 2016 compared to 2015, while our total deferred revenue balance grew 31%.
investing activities the changes in cash flows from investing activities primarily relate to timing of purchases, maturities and sales of investments, purchases of property and equipment, and payments made in connection with business acquisitions. historically, in making a lease versus purchase decision related to our larger facilities, we have considered various factors including financial metrics and the impact on our employees. in certain cases, we have elected to purchase the facility if we believed that purchasing rather than leasing is more in line with our long-term strategy. we expect to make similar decisions in the future.
during 2018, cash used in investing activities was primarily due to $60.2 million spent for purchases of our investments, net of maturities and sales of investments, $53.0 million spent on capital expenditures and $21.7 million used for the acquisitions of bradford and zonefox, net of cash acquired.
during 2017, cash used in investing activities was primarily due to $135.3 million we spent on capital expenditures, including our purchases of real estate properties in canada and sunnyvale, california, for total cash of $107.2 million. the outflow of cash was partially offset by positive cash flow due to maturities and sales, net of purchases, from our investments of $58.5 million.
during 2016, cash used in investing activities was primarily due to $67.2 million we spent on capital expenditures, including our purchases of a warehouse in union city, california, for total cash of $18.5 million, and a $22.1 million payment for the acquisition of accelops. the outflow of cash was partially offset by positive cash flow due to maturities and sales, net of purchases, from our investments of $15.1 million.
financing activities the changes in cash flows from financing activities primarily relate to repurchase and retirement of common stock, proceeds from the issuance of common stock under our equity incentive plans, taxes paid related to net share settlement of equity awards and payments of debt assumed in business combinations.
during 2018, cash used in financing activities was $202.6 million, primarily due to $211.8 million used to repurchase our common stock and $10.1 million of payments of the debt assumed in business combinations. this was partially offset by $19.3 million of proceeds from the issuance of common stock, net of tax withholding.
during 2017, cash used in financing activities was $415.6 million, primarily due to $446.3 million used to repurchase our common stock. this was partially offset by $30.7 million of proceeds from the issuance of common stock, net of tax withholding.
during 2016, cash used in financing activities was $105.9 million, primarily due to $110.8 million used to repurchase our common stock. this was partially offset by $6.5 million of proceeds from the issuance of common stock, net of tax withholding.
contractual obligations and commitments the following summarizes our contractual obligations as of december 31, 2018:
operating lease commitments (1)      $50.1               $17.1                           $20.7             $8.6                  $3.7
inventory purchase commitments (2)   177.3           173.1                       4.2                       -                     -
(2)   consists of minimum purchase commitments with independent contract manufacturers.
in addition to commitments with contract manufacturers, we have open purchase orders and contractual obligations in the ordinary course of business for which we have not received goods or services. as of december 31, 2018, we had $14.3 million in other contractual commitments having a remaining term in excess of one year that may not be cancelable.
as of december 31, 2018, we had $77.5 million of long-term income tax liabilities, including interest, related to uncertain tax positions. because of the high degree of uncertainty regarding the settlement of these liabilities, we are unable to estimate the years in which future cash outflows may occur.
off-balance sheet arrangements during 2018, 2017 and 2016, we did not have any relationships with unconsolidated organizations or financial partnerships, such as structured finance or special purpose entities that would have been established for the purpose of facilitating off-balance sheet arrangements or other contractually narrow or limited purposes.
recent accounting pronouncements see note 1 of the notes to our consolidated financial statements in part ii, item 8 of this annual report on form 10-k for a full description of recently adopted accounting pronouncements.